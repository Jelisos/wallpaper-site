# 流放管理系统后续功能实现规划

## 一、现状分析

### 1.1 已完成功能
✅ **前端界面迁移**：流放管理界面已从 `dashboard.html` 迁移至 `admin.html`  
✅ **数据库表结构**：`wallpaper_exile_status` 和 `wallpaper_operation_log` 表已创建  
✅ **基础API接口**：在 `wallpaper.php` 中已实现以下接口：
- `exile_wallpaper`：单个壁纸流放
- `recall_wallpaper`：单个壁纸召回
- `admin_get_operation_logs`：获取操作日志（分页）
- `admin_batch_recall`：批量召回壁纸

### 1.2 存在问题
❌ **批量召回接口问题**：当前实现使用 `$_POST` 获取参数，与前端 JSON 请求不匹配  
❌ **权限验证不完整**：缺少细粒度的权限控制  
❌ **错误处理不健壮**：部分异常情况处理不够完善  
❌ **日志记录不完整**：操作日志缺少详细的上下文信息  
❌ **前端交互优化**：用户体验有待提升

## 二、分步骤实施规划

### 阶段一：API接口完善（优先级：高）

#### 1.1 修复批量召回接口
**文件**：`api/wallpaper.php`  
**问题**：`handleAdminBatchRecall()` 函数使用 `$_POST` 获取参数，需改为支持 JSON 请求体

```php
// 修改前
$wallpaperIds = isset($_POST['wallpaper_ids']) ? $_POST['wallpaper_ids'] : [];

// 修改后
$wallpaperIds = $input_data['wallpaper_ids'] ?? [];
```

#### 1.2 新增批量流放接口
**功能**：支持一次性流放多个壁纸  
**接口**：`POST /api/wallpaper.php?action=admin_batch_exile`  
**参数**：
```json
{
  "action": "admin_batch_exile",
  "wallpaper_ids": [1, 2, 3],
  "comment": "批量流放原因"
}
```

#### 1.3 增强操作日志接口
**功能**：支持按条件筛选操作日志  
**新增参数**：
- `action_type`：操作类型筛选（exile/recall/admin_recall等）
- `wallpaper_id`：特定壁纸ID筛选
- `operated_by_user_id`：操作人筛选
- `date_from` / `date_to`：时间范围筛选

#### 1.4 新增流放状态统计接口
**接口**：`GET /api/wallpaper.php?action=admin_exile_stats`  
**返回数据**：
```json
{
  "total_exiled": 150,
  "total_recalled": 45,
  "today_operations": 12,
  "recent_activities": [...]
}
```

### 阶段二：权限与安全加固（优先级：高）

#### 2.1 细粒度权限控制
**文件**：新建 `api/permissions.php`  
**功能**：
- 区分超级管理员和普通管理员权限
- 支持权限级别配置（如：只能查看 vs 可以操作）
- 操作权限日志记录

#### 2.2 操作审计增强
**功能**：
- 记录操作者IP地址
- 记录操作时的用户代理信息
- 增加操作原因/备注字段的必填验证
- 敏感操作二次确认机制

#### 2.3 API安全加固
**措施**：
- 添加请求频率限制（防止恶意批量操作）
- 参数验证增强（防止SQL注入、XSS等）
- 操作日志防篡改机制

### 阶段三：前端用户体验优化（优先级：中）

#### 3.1 界面交互优化
**文件**：`static/js/admin-exile.js`  
**改进点**：
- 添加操作确认对话框（特别是批量操作）
- 实现实时状态更新（WebSocket或定时刷新）
- 优化分页加载性能
- 添加操作进度指示器

#### 3.2 数据可视化
**新增功能**：
- 流放趋势图表（按时间统计）
- 操作热力图（按操作人统计）
- 壁纸分类流放分析

#### 3.3 快捷操作功能
**新增功能**：
- 快速筛选（按状态、时间、操作人）
- 批量选择优化（全选、反选、条件选择）
- 操作历史快速回滚

### 阶段四：高级功能扩展（优先级：低）

#### 4.1 自动化流放规则
**功能**：
- 基于举报次数自动流放
- 基于内容检测自动流放
- 定时任务清理长期流放内容

#### 4.2 流放原因分类管理
**功能**：
- 预设流放原因模板
- 流放原因统计分析
- 申诉处理流程

#### 4.3 数据导出与备份
**功能**：
- 操作日志导出（Excel/CSV）
- 流放数据备份与恢复
- 数据归档策略

## 三、技术实施细节

### 3.1 数据库优化
```sql
-- 为操作日志表添加索引，提升查询性能
ALTER TABLE wallpaper_operation_log 
ADD INDEX idx_wallpaper_id (wallpaper_id),
ADD INDEX idx_action_type (action_type),
ADD INDEX idx_operation_time (operation_time),
ADD INDEX idx_operated_by_user_id (operated_by_user_id);

-- 为流放状态表添加索引
ALTER TABLE wallpaper_exile_status 
ADD INDEX idx_status (status),
ADD INDEX idx_updated_at (updated_at);
```

### 3.2 错误处理标准化
**文件**：`api/utils.php`  
**新增函数**：
```php
/**
 * 标准化错误响应
 * @param int $code HTTP状态码
 * @param string $message 错误信息
 * @param array $details 详细错误信息
 */
function sendErrorResponse($code, $message, $details = []) {
    // 记录错误日志
    sendDebugLog([
        'error_code' => $code,
        'error_message' => $message,
        'error_details' => $details,
        'request_uri' => $_SERVER['REQUEST_URI'],
        'user_id' => $_SESSION['user_id'] ?? 'anonymous'
    ], 'error.log');
    
    // 返回标准化错误响应
    http_response_code($code);
    echo json_encode([
        'success' => false,
        'code' => $code,
        'message' => $message,
        'details' => $details,
        'timestamp' => date('Y-m-d H:i:s')
    ], JSON_UNESCAPED_UNICODE);
    exit;
}
```

### 3.3 配置管理
**文件**：新建 `config/exile_config.php`  
**内容**：
```php
<?php
/**
 * 流放管理系统配置
 */
return [
    'pagination' => [
        'default_limit' => 20,
        'max_limit' => 100
    ],
    'batch_operations' => [
        'max_items' => 50,
        'require_confirmation' => true
    ],
    'permissions' => [
        'super_admin_level' => 1,
        'admin_level' => 2,
        'moderator_level' => 3
    ],
    'security' => [
        'rate_limit_per_minute' => 30,
        'require_reason_for_exile' => true,
        'log_retention_days' => 365
    ]
];
```

## 四、测试与部署计划

### 4.1 单元测试
- API接口功能测试
- 权限验证测试
- 数据库操作测试
- 错误处理测试

### 4.2 集成测试
- 前后端交互测试
- 批量操作性能测试
- 并发操作测试
- 数据一致性测试

### 4.3 部署检查清单
- [ ] 数据库索引创建
- [ ] 配置文件部署
- [ ] 权限设置验证
- [ ] 日志目录权限检查
- [ ] 备份策略确认

## 五、维护与监控

### 5.1 性能监控
- API响应时间监控
- 数据库查询性能监控
- 系统资源使用监控

### 5.2 业务监控
- 流放操作频率监控
- 异常操作告警
- 数据完整性检查

### 5.3 日志管理
- 操作日志定期归档
- 错误日志分析
- 性能日志优化建议

---

**实施建议**：
1. 优先完成阶段一的API接口完善，确保基础功能稳定
2. 阶段二的安全加固与阶段一并行进行
3. 阶段三和阶段四可根据实际需求和资源情况灵活安排
4. 每个阶段完成后进行充分测试，确保系统稳定性

**预估工期**：
- 阶段一：3-5个工作日
- 阶段二：2-3个工作日  
- 阶段三：5-7个工作日
- 阶段四：根据需求确定

**风险评估**：
- 低风险：API接口修复和完善
- 中风险：权限系统改造
- 高风险：数据库结构变更（如需要）