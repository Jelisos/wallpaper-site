1. **新增/删除图片** → 复制/删除图片到 `static/wallpapers/`
2. **生成主数据** → 运行 `python update_list.py`
3. **压缩图片** → 运行 `python compress_wallpapers.py`
4. **同步数据库** → 运行 `python sync_wallpapers_db.py`
5. **前端自动加载最新数据和压缩图，无需手动干预**
---

# 壁纸项目手动操作说明

本说明文档用于梳理**所有需要手动运行的程序**，包括其功能、启动方法、输入输出、生成文件路径及用途。便于后续维护和快速上手。

---

## 1. update_list.py —— 壁纸主数据生成

- **功能**：自动扫描 `static/wallpapers/` 目录下所有图片，生成壁纸主数据文件 `static/data/list.json`，并可生成 SQL 导入文件。
- **新增判断逻辑**：
  - **核心逻辑**：通过比较 `static/wallpapers/` 目录下实际存在的图片文件（根据文件名，不区分大小写和扩展名）与数据库 `wallpapers` 表中已记录的图片文件名。如果某个图片文件在 `static/wallpapers/` 目录中存在，但在数据库中没有对应的记录，则被视为新增图片。
  - **`list.json` 更新**：`update_list.py` 每次运行时都会根据 `static/wallpapers/` 目录的最新状态（包括新增、删除或重命名）重新生成完整的 `static/data/list.json` 文件。这意味着 `list.json` 总是反映图片目录的当前状态，而不仅仅是增量更新。
  - **ID 分配**：新增图片会被分配一个基于当前日期和递增序号的唯一 ID。

- **用途**：
  - `list.json` 是前端首页、详情页等所有壁纸展示的主数据源。
  - 也是数据库主表同步的基础数据。
- **启动方法**：
  ```bash
  cd F:\XAMPP\htdocs
  python update_list.py
  ```
- **主要输出**：
  - `static/data/list.json`（壁纸主数据文件，前端/数据库同步用）
  - `wallpapers_import.sql`（可选，批量导入SQL）
- **典型场景**：
  - 新增/删除图片后，先运行本脚本，生成最新 list.json。

---

## 2. sync_wallpapers_db.py —— 壁纸主表自动同步

- **功能**：将 `static/data/list.json` 中的壁纸数据自动同步到数据库 `wallpapers` 主表，确保主表与图片/JSON数据一致。
- **新增判断逻辑**：
  - **核心逻辑**：通过对比 `static/data/list.json` 中图片的 `id` 字段与数据库 `wallpapers` 表中已存在的 `id`。如果 `list.json` 中的某个 `id` 在数据库中不存在，则该壁纸数据被视为新增，并会被插入到数据库中。
  - **删除判断**：脚本也会识别数据库中存在，但在 `list.json` 中已经不存在的 `id`，提示这些是"已删除图片"，但不会自动删除数据库记录，需要用户手动确认。

- **用途**：
  - 保证数据库主表和前端数据、图片目录完全同步。
  - 点赞、收藏等功能依赖主表ID，防止数据错乱。
- **启动方法**：
  ```bash
  cd F:\XAMPP\htdocs
  python sync_wallpapers_db.py
  ```
- **主要输出**：
  - 直接写入数据库，无额外文件。
  - 控制台输出同步结果（如"新增壁纸已同步到数据库，共XX条"）。
- **典型场景**：
  - 每次运行完 update_list.py 后，务必运行本脚本，保持数据库同步。

---

## 3. compress_wallpapers.py —— 壁纸图片批量压缩

- **功能**：批量压缩 `static/wallpapers/` 目录下的所有图片，生成高效预览图，优化前端加载速度。
- **新增判断逻辑**：
  - **核心逻辑**：脚本会遍历 `static/wallpapers/` 目录（排除 `preview` 子目录）下的所有图片文件。对于每个图片文件，它会检查在 `static/wallpapers/preview/` 目标目录中是否存在一个同名（不含 `_preview` 后缀）且相同格式的压缩文件。
  - **跳过逻辑**：如果目标压缩文件已经存在，并且没有使用 `-f` (force) 参数，脚本会跳过对该图片的压缩，因为它被认为是"已处理"或"无需新增压缩"。
  - **强制压缩**：如果使用 `-f` 参数，则所有图片都会被强制重新压缩，无论目标文件是否存在。
  - **不依赖数据库或 `list.json`**：`compress_wallpapers.py` 的判断逻辑完全基于文件系统，不与数据库或 `list.json` 进行交互，确保了其独立性。

- **用途**：
  - 生成的压缩图用于前端首页、详情页的图片预览，提升加载速度和用户体验。
- **启动方法**：
  ```bash
  cd F:\XAMPP\htdocs
  python compress_wallpapers.py
  ```
  - 可选参数：
    - `-f` 强制重新压缩所有图片（默认只压缩新增/未压缩的）
    - `-d 路径` 指定自定义图片目录
    - `-t preview` 只生成预览图（默认）
- **主要输出**：
  - `static/wallpapers/preview/` 目录下的压缩图片（与原图同名，格式为jpeg）
- **典型场景**：
  - 新增图片后，建议运行本脚本，生成/更新预览图，前端自动优先加载压缩版。

---

## 4. 操作建议与典型流程

1. **新增/删除图片** → 复制/删除图片到 `static/wallpapers/`
2. **生成主数据** → 运行 `python update_list.py`
3. **压缩图片** → 运行 `python compress_wallpapers.py`
4. **同步数据库** → 运行 `python sync_wallpapers_db.py`
5. **前端自动加载最新数据和压缩图，无需手动干预**

---

## 5. 生成文件与用途一览

| 文件/目录                        | 生成方式                | 用途说明                   |
|----------------------------------|-------------------------|----------------------------|
| static/data/list.json            | update_list.py          | 前端壁纸主数据，数据库同步 |
| wallpapers_import.sql            | update_list.py          | 可选，批量导入SQL          |
| static/wallpapers/preview/       | compress_wallpapers.py  | 前端预览图目录             |
| 数据库表 wallpapers              | sync_wallpapers_db.py   | 主表，点赞/收藏等依赖      |

---

如需补充其他脚本或有新需求，随时吩咐！
