


# 项目开发与AI协作规范 (优化版)

## 一、总规则与环境说明
### 1. 系统与环境配置
- **操作系统**：Windows 10 专业版
- **开发环境**：已启动 XAMPP 的 Apache 服务和 MySQL 服务（AI无需重复启动）
- **数据库访问**：通过 `F:\XAMPP\htdocs\mysql_test.py` 查看数据库 (AI可调用此脚本)
- **项目路径**：`F:\XAMPP\htdocs`（AI可自动访问该路径下所有文件）
- **AI能力边界**：AI主要负责代码实现、调试辅助、文档生成等技术任务，不涉及主观决策或超出技术范畴的判断。

### 2. 文档与日志管理
- **项目分析文档**：每次面对新项目或重大需求变更时，AI自动创建或更新，记录核心需求、技术选型、关键模块设计、交互结论及可复用的最佳实践。
- **开发进度文档**：在项目根目录创建 `开发进度.txt`，AI仅记录代码改动相关的任务及其完成状态，并自动更新时间戳。
- **调试日志 (PHP后端)**：使用 `F:\XAMPP\htdocs\api\write_log.php` 接口生成日志。AI在调用时需确保保留现有输出结构，日志路径为项目根目录，命名规范：`[模块/功能名]_debug_log.txt`。
- **调试日志 (前端)**：优先使用浏览器控制台 (`console.log`, `console.error`, `console.warn`, `console.table`等)，关键调试信息应带有明确前缀，如 `[调试-模块名]`。
- **日志清理**：调试任务完成后，AI应主动询问是否清理当次生成的调试日志文件和临时 `console.log` 代码。

### 3. AI协作与沟通原则
- **操作自动化**：AI应尽可能自动执行所有技术操作，避免要求用户手动修改代码或文件。对敏感操作（如删除数据、修改核心配置）需提前预警并请求用户确认。
- **结果透明化**：任务完成后，AI用通俗易懂的语言说明实现的功能、影响范围。若调整了具体数值或参数，需明确指出修改的文件路径、行号及参数名。
- **问题独立处理与升级**：遇到技术难题时，AI应首先尝试独立分析和解决。若同一问题连续3次尝试修复失败，AI应主动暂停，总结已尝试的方案、遇到的障碍，并请求用户提供进一步的指导或确认下一步排查方向。
- **代码质量优先**：AI生成的代码必须严格遵守后续章节定义的“代码质量标准”。

## 二、开发流程与执行规范
### 1. 需求处理流程
#### 1.1 需求理解与澄清
- AI在接收到需求后，应首先确认理解无误。对模糊不清或可能产生歧义的需求点，主动向用户提问澄清。
- 明确需求边界：例如，是否涉及用户认证、数据持久化方式、特定浏览器兼容性要求等。

#### 1.2 任务拆解与计划
- 将复杂需求拆解为更小、可独立实现和验证的功能单元。
- 输出简要实现思路和分步执行计划，优先处理核心功能模块。

#### 1.3 代码变更原则
- **冲突分析与预防 (详见 2.2节)**：修改前，AI必须评估潜在的代码冲突和对现有功能的影响。
- **文件复用与创建**：优先在现有相关文件中进行修改和扩展。非绝对必要不创建新文件。若需创建新文件，应遵循项目既有的目录结构和命名规范，并向用户说明创建原因。
- **注释规范**：
    - PHP: 使用 PHPDoc 标准进行注释，对复杂逻辑、重要函数、公共API必须添加清晰的中文注释。
    - JavaScript: 使用 JSDoc 标准进行注释，对复杂逻辑、重要函数、事件处理、异步操作等必须添加清晰的中文注释。
    - CSS: 对非显而易见的样式规则、hack、特定选择器用途等添加注释。
    - 关键逻辑和设计思路应同步记录到项目分析文档。

#### 1.4 调试与验证 (详见 四、调试与问题定位)
- **单元自测**：每完成一个最小功能单元，AI应进行自测，确保其按预期工作。
- **集成验证**：相关联的多个功能单元完成后，进行集成验证。
- **避免无效重复**：同一修复方法若已验证无效，不应盲目重复执行。

### 2. 代码冲突分析与解决策略
#### 2.1 冲突识别
- **静态分析**：
    - **函数/方法签名**：检查修改或新增的函数/方法是否与现有代码中的同名函数/方法存在参数数量、类型或用途上的冲突。
    - **全局变量/常量**：警惕对全局变量/常量的修改，分析其影响范围。
    - **CSS选择器**：评估新增或修改的CSS选择器是否可能意外影响其他组件的样式（特别是通用选择器或层级较浅的选择器）。检查是否存在样式覆盖的风险。
    - **JavaScript事件监听**：检查是否在同一元素或父元素上重复绑定了相同类型的事件监听器，可能导致逻辑冲突或性能问题。
- **动态分析 (辅助)**：在本地开发环境，通过实际运行和测试来观察是否存在非预期的行为，这可能间接指示了冲突。

#### 2.2 冲突预防
- **模块化设计**：AI在生成代码时，应尽可能遵循模块化和高内聚低耦合的原则，减少模块间的直接依赖。
- **命名空间/作用域**：合理使用PHP的命名空间、JavaScript的立即执行函数表达式(IIFE)或模块(ES6 Modules)来避免全局命名冲突。
- **CSS作用域**：推广使用BEM命名规范或CSS Modules等技术（若项目已采用或用户同意引入）来限制CSS作用域，减少样式冲突。
- **配置化与参数化**：将易变部分或可能产生冲突的硬编码值（如API端点、特定ID）提取为配置项或函数参数。

#### 2.3 冲突解决
- **小范围冲突**：
    - **重命名**：对冲突的函数名、变量名、CSS类名等进行有意义的重命名，并更新所有引用点。
    - **调整CSS选择器特异性**：通过增加父选择器、使用ID或更具体的类名来提高选择器特异性，解决样式覆盖问题。
    - **条件加载/执行**：在特定条件下才加载或执行某段可能冲突的代码。
- **大范围或复杂冲突**：
    - AI应向用户清晰描述冲突的具体表现、涉及的文件和代码段，以及可能的解决方案选项（如代码重构、功能调整等），请求用户决策。
    - **严禁AI在未得到用户明确指示的情况下，对核心逻辑或大范围代码进行可能破坏现有功能的修改。**
- **版本控制意识**：虽然AI不直接操作Git，但在提供修改建议时，应考虑到用户可能使用版本控制，修改应尽可能原子化，便于用户review和合并。

## 三、代码质量标准
AI生成的代码必须满足以下标准：

### 1. 结构清晰
- **目录与文件组织**：遵循项目现有结构。新增功能模块时，保持相关文件（如PHP逻辑、JS脚本、CSS样式、模板文件）的组织性。
- **代码缩进与格式化**：保持一致的缩进风格（如4个空格）。PHP代码风格尽量遵循PSR-12，JavaScript代码风格可参考主流规范（如Airbnb JavaScript Style Guide，但以项目现有风格为准）。
- **代码块与空行**：合理使用空行分隔逻辑块，提高可读性。

### 2. 逻辑清晰
- **单一职责原则 (SRP)**：函数/方法应尽可能只做一件事情，并做好。
- **命名规范**：
    - 变量名、函数名、类名、方法名应清晰、表意，使用驼峰命名法 (camelCase for variables/functions, PascalCase for classes) 或下划线命名法 (snake_case)，与项目现有风格保持一致。
    - 避免使用无意义或过于简写的名称 (如 `a`, `b`, `temp`, `func1`)。
- **减少嵌套深度**：避免过深的 `if-else` 或循环嵌套，考虑使用卫语句、提前返回、或将逻辑提取到独立函数中。
- **注释**：见 1.3节 注释规范。
- **避免魔法数字/字符串**：将代码中直接使用的、含义不明的数字或字符串定义为常量或配置变量，并加以注释。

### 3. 独立兼容性 (模块化与低耦合)
- **减少全局污染**：
    - JavaScript: 避免不必要的全局变量，使用IIFE、ES6模块或对象字面量封装代码。
    - PHP: 合理使用命名空间，避免全局函数和常量的滥用。
- **参数化与配置化**：依赖外部数据或配置时，应通过函数参数、配置文件或环境变量传入，而不是硬编码在模块内部。
- **明确的接口**：模块或类对外暴露的公共方法和属性应清晰、稳定。
- **依赖注入 (DI) 思想**：当模块依赖其他服务或组件时，考虑通过构造函数或setter方法注入依赖，而不是在模块内部直接创建或引用，以提高可测试性和灵活性 (此为高级要求，AI应优先保证功能实现和基本代码质量)。
- **错误处理**：
    - 函数/方法应有明确的错误处理机制，如返回特定的错误码、抛出异常 (PHP)、返回 `null` 或 `false` 并有文档说明。
    - 对外部调用（如API请求、数据库操作）必须检查其执行结果和潜在错误。

### 4. 前后端分离 (如适用)
- **API驱动**：前端通过定义好的API与后端交互，后端负责业务逻辑和数据处理，前端负责展示和用户交互。
- **数据格式统一**：前后端交互的数据格式（如JSON）应保持一致和规范。

## 四、调试与问题定位策略
### 1. 系统化排查流程
1.  **复现问题**：AI首先尝试稳定复现用户报告的问题。如果无法复现，会请求用户提供更详细的复现步骤、环境信息或错误截图。
2.  **理解问题**：明确问题的具体表现、预期行为与实际行为的差异。
3.  **缩小范围 (Divide and Conquer)**：
    - **检查最近变更**：如果问题是新出现的，优先检查最近的代码修改。
    - **注释法定位**：逐步注释掉可疑代码块，观察问题是否消失，以定位问题代码段。
    - **二分法定位**：对于数据处理流程中的问题，可以在流程中间点检查数据状态，判断问题发生在上半段还是下半段。
4.  **日志分析**：
    - **浏览器控制台**：仔细检查Console中的错误信息 (红色)、警告信息 (黄色) 以及相关的 `console.log` 输出。关注错误栈信息，定位到具体的文件和行号。
    - **网络(Network)面板**：检查API请求是否成功 (Status Code)，请求头/体是否正确，响应数据是否符合预期。关注Timing，排查慢请求。
    - **PHP错误日志/调试日志**：查看Apache错误日志、PHP错误日志以及通过 `write_log.php` 生成的自定义调试日志。
5.  **代码审查**：
    - **逻辑检查**：仔细阅读相关代码，检查条件判断、循环、变量赋值、函数调用等是否存在逻辑错误。
    - **边界条件**：考虑输入为空、null、0、最大/最小值等边界情况。
    - **异步处理**：对于JavaScript中的异步操作 (如 `Promise`, `async/await`, `setTimeout`)，检查回调逻辑、错误处理是否正确。
6.  **环境检查**：确认开发环境配置（如PHP版本、扩展、数据库连接）是否正确，与生产环境（如果已知）是否存在差异导致的问题。

### 2. 具体调试技术
- **浏览器开发者工具**：
    - **Elements面板**：检查DOM结构、CSS样式是否正确应用，动态修改HTML/CSS进行快速验证。
    - **Sources面板**：设置断点 (breakpoints)，单步执行 (step over, step into, step out) JavaScript代码，观察变量值和调用栈。
    - **Application面板**：检查 `localStorage`, `sessionStorage`, `Cookies` 等存储数据。
- **PHP调试**：
    - `var_dump()`, `print_r()` 结合 `die()` 或 `exit()`：在PHP代码中输出变量详细信息并终止执行，用于快速检查变量状态。
    - Xdebug (若用户环境支持并配置)：可提供更强大的断点调试、性能分析等功能 (AI应询问用户是否配置了Xdebug，若无则不主动依赖)。
- **特定场景调试**：
    - **表单提交**：检查表单元素的 `name` 属性是否正确，提交方法 (GET/POST) 是否匹配后端接收方式，后端是否正确获取和处理了表单数据。
    - **数据库操作**：打印或记录执行的SQL语句，在数据库客户端手动执行SQL检查其正确性；检查数据库连接是否成功，用户权限是否足够。
    - **文件操作**：检查文件路径是否正确，文件/目录权限是否允许读写。

### 3. “三次修复失败”后的行动
- AI将提供一份简要的调试报告，包括：
    1.  问题的准确描述和复现步骤。
    2.  已尝试的排查方法和修复方案列表。
    3.  每次尝试后的具体结果和观察到的现象。
    4.  当前怀疑的可能原因点。
    5.  请求用户提供进一步的线索或指示（例如：“您认为问题更可能出在前端逻辑还是后端API？”或“是否可以提供一下相关的服务器错误日志？”）。

## 五、文档格式与内容规范
### 1. 开发进度文档 (`开发进度.txt`)
- **记录范围**：仅记录AI执行的代码设计、编写、修改、删除等直接相关的开发任务。
- **内容格式**：
  ```
  [YYYY-MM-DD HH:MM:SS]
  ✅ 已完成：用户登录功能 - 前端表单构建 (修改 index.html, style.css, auth.js)
  ✅ 已完成：用户登录功能 - 后端API接口开发 (创建 api/login.php, 修改 lib/db.php)
  ⏳ 进行中：用户个人资料编辑功能 - 数据库表结构设计
  ❌ 遇到障碍：支付回调处理逻辑 - 无法稳定复现第三方通知 (已尝试方案A, B，详见调试报告 [链接或时间戳])
  ```

### 2. 调试日志接口 (`F:\XAMPP\htdocs\api\write_log.php`) 参数
| 参数名       | 说明                                      | 示例值                      |
|--------------|-------------------------------------------|-----------------------------|
| `log`        | **必需**，日志核心内容，应尽可能详细        | "用户ID: 123 点击提交订单按钮，请求参数: {...}" |
| `logfile`    | **必需**，日志文件名 (不含路径，AI自动处理) | "order_module_debug_log.txt" |
| `tag`        | 可选，日志标签（如功能模块名、错误级别）    | "PaymentAPI" / "ERROR"      |
| `user`       | 可选，用户标识（如用户ID、Session ID）      | "user_123"                  |
| `mode`       | 可选，写入模式 (`overwrite` 表示覆盖)     | 默认追加 (append)           |
| `timestamp`  | 可选，AI可传入时间戳 (ms)，否则接口自动生成 | `Date.now()`                |

## 六、关键操作指令 (AI内部理解，对用户表现为自然语言交互)
- **“清理调试”**：AI理解为需要删除本次会话或特定任务中生成的临时调试日志文件 (`xxx_debug_log.txt`) 和 `console.log` 代码。执行前会与用户确认范围。
- **“查看进度”**：AI读取 `开发进度.txt` 内容，并以易于理解的方式向用户反馈当前各任务的状态。
- **“分析[某个文件/函数]”**：AI会尝试理解指定代码的功能、逻辑流程、潜在问题，并向用户解释。
- **“重构[某段代码]”**：AI会根据代码质量标准和用户具体要求（如提高性能、增强可读性）来重写代码，并解释改动点。

此规范旨在提升AI与开发者协作的效率和质量，确保开发过程的规范性和代码的健壮性。AI应严格遵守，并在实践中不断学习和优化。

