<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多设备壁纸预览</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <link href="static/css/main.css" rel="stylesheet">
    <link href="static/css/yulan.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#86909C',
                        accent: '#FF7D00',
                        dark: '#1D2129',
                        light: '#F2F3F5',
                        'apple-gray': '#8E8E93',
                        'apple-dark': '#1C1C1E',
                        'apple-white': '#F9F9F9'
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-light to-gray-100 min-h-screen font-inter text-dark">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- 头部 -->
        <header class="text-center mb-12">
            <h1 class="text-[clamp(2rem,5vw,3.5rem)] font-bold text-primary mb-4 tracking-tight">
                <span class="text-accent">多设备</span>壁纸预览
            </h1>
            <p class="text-gray-600 text-[clamp(1rem,2vw,1.25rem)] max-w-2xl mx-auto">
                上传你的壁纸，在手机、平板和电脑上预览效果，下载适配不同设备的壁纸
            </p>
        </header>

        <div class="flex flex-col lg:flex-row gap-12 items-center justify-center">
            <!-- 设备预览区域 -->
            <div class="w-full lg:w-1/2">
                <!-- 设备选择标签 -->
                <div class="device-tabs mb-6">
                    <div class="device-tab active" data-device="phone">
                        <i class="fa-solid fa-mobile-screen-button mr-2"></i>手机
                    </div>
                    <div class="device-tab" data-device="tablet">
                        <i class="fa-solid fa-tablet-screen-button mr-2"></i>平板
                    </div>
                    <div class="device-tab" data-device="laptop">
                        <i class="fa-solid fa-laptop mr-2"></i>电脑
                    </div>
                    <div class="device-tab" data-device="moment">
                        <i class="fa-solid fa-image mr-2"></i>朋友圈
                    </div>
                </div>

                <!-- 设备预览容器 -->
                <div class="relative">
                    <!-- 手机预览 -->
                    <div class="device-preview" id="phonePreview">
                        <div class="relative phone-rotate">
                            <canvas id="phoneCanvas" class="mx-auto phone-shadow rounded-[40px] phone-bezel"></canvas>
                            <!-- 苹果手机刘海 -->
                            <div class="apple-notch"></div>
                        </div>
                    </div>

                    <!-- 平板预览 -->
                    <div class="device-preview hidden" id="tabletPreview">
                        <div class="relative tablet-rotate">
                            <canvas id="tabletCanvas" class="mx-auto phone-shadow rounded-[25px] phone-bezel"></canvas>
                        </div>
                    </div>

                    <!-- 电脑预览 -->
                    <div class="device-preview hidden" id="laptopPreview">
                        <div class="relative laptop-rotate">
                            <canvas id="laptopCanvas" class="mx-auto"></canvas>
                        </div>
                    </div>

                    <!-- 朋友圈预览 -->
                    <div class="device-preview hidden" id="momentPreview">
                        <div class="relative flex justify-center">
                            <canvas id="momentCanvas" class="mx-auto rounded-2xl shadow-lg" style="max-width:720px;width:100%;height:auto;display:block;"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 功能区域 -->
            <div class="w-full lg:w-1/2 flex flex-col items-center">
                <!-- 上传区域 -->
                <div id="uploadArea" class="upload-area w-full max-w-md bg-white rounded-2xl p-8 shadow-lg mb-8 border-2 border-dashed border-gray-300 hover:border-primary transition-all duration-300">
                    <label for="wallpaperUpload" class="cursor-pointer flex flex-col items-center justify-center">
                        <div class="text-center mb-4">
                            <i class="fa-solid fa-cloud-arrow-up text-4xl text-primary mb-3"></i>
                            <h3 class="text-xl font-semibold mb-2">上传壁纸</h3>
                            <p class="text-gray-500 text-sm">点击或拖拽图片到此处 (支持 JPG, PNG, WebP)</p>
                        </div>
                        <input type="file" id="wallpaperUpload" accept="image/*" class="hidden" />
                        <button id="uploadButton" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-3 px-6 rounded-lg transition-all duration-300 button-hover button-shadow flex items-center justify-center">
                            <i class="fa-solid fa-image mr-2"></i> 选择壁纸
                        </button>
                    </label>
                </div>

                <!-- 预览控制区域 -->
                <div id="previewControls" class="w-full max-w-md bg-white rounded-2xl p-6 shadow-lg mb-8 hidden">
                    <h3 class="text-xl font-semibold mb-4">壁纸预览</h3>
                    
                    <!-- 壁纸预览小窗口 -->
                    <div class="relative w-full aspect-[146/76] bg-gray-100 rounded-xl mb-6 overflow-hidden flex items-center justify-center" style="min-height:220px;">
                        <img id="previewImage" src="" alt="壁纸预览" class="max-w-full max-h-80 object-contain rounded-xl shadow transition-all duration-300" style="aspect-ratio:146/76; background:#eee;">
                    </div>
                    
                    <!-- 控制按钮 -->
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="downloadPhoneButton" class="flex-1 bg-accent hover:bg-accent/90 text-white font-medium py-3 px-6 rounded-lg transition-all duration-300 button-hover button-shadow flex items-center justify-center">
                            <i class="fa-solid fa-mobile-screen-button mr-2"></i> 手机
                        </button>
                        <button id="downloadTabletButton" class="flex-1 bg-secondary hover:bg-secondary/90 text-white font-medium py-3 px-6 rounded-lg transition-all duration-300 button-hover button-shadow flex items-center justify-center">
                            <i class="fa-solid fa-tablet-screen-button mr-2"></i> 平板
                        </button>
                        <button id="downloadLaptopButton" class="flex-1 bg-primary hover:bg-primary/90 text-white font-medium py-3 px-6 rounded-lg transition-all duration-300 button-hover button-shadow flex items-center justify-center">
                            <i class="fa-solid fa-laptop mr-2"></i> 电脑
                        </button>
                    </div>
                    

                    
                    <!-- 微信头像和封面下载按钮 -->
                    <div class="mt-4 flex flex-col sm:flex-row gap-4">
                        <button id="downloadAvatarButton" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-medium py-3 px-6 rounded-lg transition-all duration-300 button-hover button-shadow flex items-center justify-center">
                            <i class="fa-solid fa-user-circle mr-2"></i> 头像
                        </button>
                        <button id="downloadCoverButton" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-6 rounded-lg transition-all duration-300 button-hover button-shadow flex items-center justify-center">
                            <i class="fa-solid fa-image mr-2"></i> 封面
                        </button>
                        <button id="downloadBothButton" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white font-medium py-3 px-6 rounded-lg transition-all duration-300 button-hover button-shadow flex items-center justify-center">
                            <i class="fa-solid fa-download mr-2"></i> 组合
                        </button>
                    </div>

                    <!-- 一键下载高清壁纸按钮 -->
                    <div class="mt-4 flex flex-col sm:flex-row gap-4">
                        <button id="downloadHDAllButton" class="w-full bg-gradient-to-r from-blue-500 to-green-400 hover:from-blue-600 hover:to-green-500 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 button-hover button-shadow flex items-center justify-center">
                            <i class="fa-solid fa-cloud-arrow-down mr-2"></i> 一键下载高清壁纸（手机/平板/电脑）
                        </button>
                    </div>

                     <!-- 调试控制区域 -->
                     <div class="mt-6 pt-4 border-t border-gray-200">
                        <h4 class="font-semibold text-sm mb-2 flex items-center">
                            <i class="fa-solid fa-sliders text-secondary mr-2"></i> 壁纸位置调整（电脑实时预览）
                        </h4>
                        <div class="flex items-center gap-2">
                            <button id="moveUpBtn" class="px-3 py-1 bg-gray-200 rounded-lg text-sm hover:bg-gray-300">
                                <i class="fa-solid fa-arrow-up"></i> 上移
                            </button>
                            <button id="moveDownBtn" class="px-3 py-1 bg-gray-200 rounded-lg text-sm hover:bg-gray-300">
                                <i class="fa-solid fa-arrow-down"></i> 下移
                            </button>
                            <span id="offsetValue" class="text-xs text-gray-500">偏移: 0px</span>
                        </div>
                    </div>                   

                </div>

                <!-- 信息卡片 -->
                <div class="w-full max-w-md bg-white rounded-2xl p-6 shadow-lg">
                    <!-- 下载原图按钮（新增） -->
                    <button id="downloadOriginalButton" class="w-full mb-4 bg-primary hover:bg-primary/90 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 button-hover button-shadow flex items-center justify-center">
                        <i class="fa-solid fa-download mr-2"></i> 下载原图
                    </button>
                    <h3 class="text-xl font-semibold mb-3 flex items-center">
                        <i class="fa-solid fa-info-circle text-primary mr-2"></i> 使用说明
                    </h3>
                    <ul class="space-y-2 text-gray-600">
                        <li class="flex items-start">
                            <i class="fa-solid fa-check-circle text-primary mt-1 mr-2"></i>
                            <span>点击"选择壁纸"按钮上传本地图片</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fa-solid fa-check-circle text-primary mt-1 mr-2"></i>
                            <span>上传后可在左侧预览不同设备的效果</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fa-solid fa-check-circle text-primary mt-1 mr-2"></i>
                            <span>点击对应按钮下载适配不同设备的壁纸</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fa-solid fa-check-circle text-primary mt-1 mr-2"></i>
                            <span>支持 JPG、PNG 和 WebP 格式图片</span>
                        </li>
                    </ul>
                    

                </div>
            </div>
        </div>

        <!-- 页脚 -->
        <footer class="mt-16 text-center text-gray-500 text-sm">
            <p>© 2025 多设备壁纸预览工具 | 仅供演示使用</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (window.location.hash === '#previewControls') {
                const target = document.getElementById('previewControls');
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
            // 获取DOM元素
            const phoneCanvas = document.getElementById('phoneCanvas');
            const tabletCanvas = document.getElementById('tabletCanvas');
            const laptopCanvas = document.getElementById('laptopCanvas');
            
            const phoneCtx = phoneCanvas.getContext('2d');
            const tabletCtx = tabletCanvas.getContext('2d');
            const laptopCtx = laptopCanvas.getContext('2d');
            
            const wallpaperUpload = document.getElementById('wallpaperUpload');
            const uploadButton = document.getElementById('uploadButton');
            const uploadArea = document.getElementById('uploadArea');
            const previewControls = document.getElementById('previewControls');
            const previewImage = document.getElementById('previewImage');
            
            const downloadPhoneButton = document.getElementById('downloadPhoneButton');
            const downloadTabletButton = document.getElementById('downloadTabletButton');
            const downloadLaptopButton = document.getElementById('downloadLaptopButton');
            
            // 新增微信相关按钮
            const downloadAvatarButton = document.getElementById('downloadAvatarButton');
            const downloadCoverButton = document.getElementById('downloadCoverButton');
            const downloadBothButton = document.getElementById('downloadBothButton');
            
            // 微信头像和封面尺寸定义
            const avatarSize = {
                width: 300,
                height: 300,
                radius: 150,
                roundRadius: 20  // 圆角方形头像的圆角半径
            };
            
            const coverSize = {
                width: 750,
                height: 422
            };
            
            const deviceTabs = document.querySelectorAll('.device-tab');
            const devicePreviews = document.querySelectorAll('.device-preview');
            
            // 调试控制元素
            const moveUpBtn = document.getElementById('moveUpBtn');
            const moveDownBtn = document.getElementById('moveDownBtn');
            const offsetValue = document.getElementById('offsetValue');
            
            // 设备尺寸比例
            const phoneWidth = 300;
            const phoneHeight = 620;
            const phoneBezelWidth = 8; // 手机边框宽度
            const phoneCornerRadius = 40; // 手机圆角半径
            
            const tabletWidth = 420;
            const tabletHeight = 560;
            const tabletBezelWidth = 12; // 平板边框宽度
            const tabletCornerRadius = 25; // 平板圆角半径
            
            const laptopWidth = 550;
            const laptopHeight = 360;
            const laptopScreenHeight = 320;
            const laptopBezelWidth = 8; // 电脑边框宽度
            const laptopBaseHeight = 40; // 电脑底座高度
            
            // 朋友圈封面尺寸
            const momentWidth = 550;
            const momentHeight = 372;
            const momentBarHeight = 100; // 底部白色栏高度
            const momentAvatarSize = 90;
            const momentAvatarRadius = 15;
            const momentAvatarMargin = 15;
            const momentName = 'Jelis';
            let momentAvatarImg = null;
            
            // 壁纸位置偏移量
            let yOffset = 100;
            
            // 适配高DPI屏幕
            const dpr = window.devicePixelRatio || 1;
            function setCanvasHD(canvas, width, height) {
                canvas.width = width * dpr;
                canvas.height = height * dpr;
                canvas.style.width = width + 'px';
                canvas.style.height = height + 'px';
                const ctx = canvas.getContext('2d');
                ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
                return ctx;
            }
            // 设置所有canvas为高清
            setCanvasHD(phoneCanvas, phoneWidth, phoneHeight);
            setCanvasHD(tabletCanvas, tabletWidth, tabletHeight);
            setCanvasHD(laptopCanvas, laptopWidth, laptopHeight + laptopBaseHeight);
            setCanvasHD(momentCanvas, momentWidth, momentHeight);
            // 修复朋友圈canvas context丢失
            momentCtx = momentCanvas.getContext('2d');
            
            // 壁纸文件名数组（如有新图片请手动添加到此数组）
            const wallpapers = [
                { filename: '机械少女2.jpeg', path: 'static/wallpapers/机械少女2.jpeg' },
                { filename: '机械少女.jpeg', path: 'static/wallpapers/机械少女.jpeg' },
                { filename: '血色残阳.jpeg', path: 'static/wallpapers/血色残阳.jpeg' },
                { filename: '神秘人.png', path: 'static/wallpapers/神秘人.png' },
                { filename: '兽耳娘.png', path: 'static/wallpapers/兽耳娘.png' }
            ];

            // 获取URL参数中的图片
            const urlParams = new URLSearchParams(window.location.search);
            let imageUrl = urlParams.get('image');

            // 简化图片URL处理逻辑：直接使用从URL参数获取的imageUrl
            // 假设从首页传递过来的imageUrl就是原始图片的正确路径

            if (imageUrl) {
                // 如果有图片URL，加载该图片
                loadAndDisplayWallpaper(imageUrl);
            } else {
                // 如果没有图片URL，不加载任何图片，等待用户上传
                 console.log('没有指定图片URL，请上传。');
                 // 可以在这里加载一个默认的提示图，或者保持空白
            }

            // 设备切换
            deviceTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // 移除所有活动状态
                    deviceTabs.forEach(t => t.classList.remove('active'));
                    devicePreviews.forEach(p => p.classList.add('hidden'));
                    
                    // 添加当前活动状态
                    tab.classList.add('active');
                    const device = tab.getAttribute('data-device');
                    document.getElementById(`${device}Preview`).classList.remove('hidden');
                    
                    // 切换到朋友圈时重绘
                    if(device === 'moment') {
                        drawMomentPreview(currentWallpaper, currentWallpaper || momentAvatarImg, yOffset);
                    } else if (device === 'phone') {
                        drawPhone(currentWallpaper);
                    } else if (device === 'tablet') {
                        drawTablet(currentWallpaper);
                    } else if (device === 'laptop') {
                        drawLaptop(currentWallpaper);
                    }
                });
            });
            
            // 上传按钮点击事件
            uploadButton.addEventListener('click', () => {
                wallpaperUpload.click();
            });
            
            // 文件上传事件
            wallpaperUpload.addEventListener('change', handleFileUpload);
            
            // 拖拽上传
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('border-primary');
                uploadArea.classList.add('bg-gray-50');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('border-primary');
                uploadArea.classList.remove('bg-gray-50');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-primary');
                uploadArea.classList.remove('bg-gray-50');
                
                if (e.dataTransfer.files.length) {
                    wallpaperUpload.files = e.dataTransfer.files;
                    handleFileUpload();
                }
            });
            
            // 下载按钮点击事件
            downloadPhoneButton.addEventListener('click', () => downloadPreview(phoneCanvas, '手机', 'phone'));
            downloadTabletButton.addEventListener('click', () => downloadPreview(tabletCanvas, '平板', 'tablet'));
            downloadLaptopButton.addEventListener('click', () => downloadPreview(laptopCanvas, '电脑', 'laptop'));
            
            // 新增微信相关下载事件
            downloadAvatarButton.addEventListener('click', downloadAvatar);
            downloadCoverButton.addEventListener('click', downloadCover);
            downloadBothButton.addEventListener('click', downloadBoth);
            
            // 一键下载高清壁纸按钮
            const downloadHDAllButton = document.getElementById('downloadHDAllButton');
            downloadHDAllButton.addEventListener('click', function() {
                // 直接使用已经加载到 currentWallpaper 的原图对象
                if (!currentWallpaper || !currentWallpaper.complete || currentWallpaper.naturalWidth === 0) {
                    alert('壁纸未加载或加载异常，无法导出高清壁纸！');
                    // 尝试恢复按钮状态
                    downloadHDAllButton.innerHTML = '<i class="fa-solid fa-times mr-2"></i> 导出失败';
                     downloadHDAllButton.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-green-400', 'hover:from-blue-600', 'hover:to-green-500');
                     downloadHDAllButton.classList.add('bg-red-500');
                     setTimeout(() => {
                         downloadHDAllButton.classList.remove('bg-red-500');
                         downloadHDAllButton.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-green-400', 'hover:from-blue-600', 'hover:to-green-500');
                         downloadHDAllButton.disabled = false;
                     }, 2000);
                    return;
                }
                downloadHDAllButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> 下载中...';
                downloadHDAllButton.disabled = true;
                let exportComplete = false; // 标记导出是否完成

                // 高清导出函数，直接使用 currentWallpaper 对象
                const performHDExport = async (img) => { // 修改为异步函数
                     // 手机 - 提高分辨率到2K
                     const phoneSuccess = await exportHDWallpaper(img, 1440, 3200, '手机高清壁纸.jpg');
                     // 平板 - 提高分辨率到4K
                     const tabletSuccess = await exportHDWallpaper(img, 2560, 3840, '平板高清壁纸.jpg');
                     // 电脑 - 提高分辨率到4K，内容区yOffset等比例缩放（与预览一致，无补偿）
                     /**
                      * 电脑壁纸导出时，yOffset等比例缩放，保证与预览一致
                      * 预览内容区高度为：laptopScreenHeight - 3 * laptopBezelWidth
                      * 导出内容区高度为：2160
                      */
                     const previewContentHeight = laptopScreenHeight - 3 * laptopBezelWidth; // 296
                     const exportContentHeight = 2160;
                     const scaledYOffset = yOffset * (exportContentHeight / previewContentHeight); // 仅等比例缩放
                     const laptopSuccess = await exportHDWallpaper(img, 3840, 2160, '电脑高清壁纸.jpg', scaledYOffset);

                     // 检查所有导出是否成功
                     if (phoneSuccess && tabletSuccess && laptopSuccess) {
                          // 标记导出完成，更新按钮状态
                          downloadHDAllButton.innerHTML = '<i class="fa-solid fa-check mr-2"></i> 下载成功';
                          downloadHDAllButton.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-green-400', 'hover:from-blue-600', 'hover:to-green-500');
                          downloadHDAllButton.classList.add('bg-green-500');
                          exportComplete = true;
                          // 延迟恢复按钮状态
                          setTimeout(() => {
                              downloadHDAllButton.classList.remove('bg-green-500');
                              downloadHDAllButton.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-green-400', 'hover:from-blue-600', 'hover:to-green-500');
                              downloadHDAllButton.disabled = false;
                         }, 2000);
                     } else {
                          // 任何一个导出失败，显示失败状态
                           downloadHDAllButton.innerHTML = '<i class="fa-solid fa-times mr-2"></i> 导出失败';
                          downloadHDAllButton.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-green-400', 'hover:from-blue-600', 'hover:to-green-500');
                          downloadHDAllButton.classList.add('bg-red-500');
                          setTimeout(() => {
                              downloadHDAllButton.classList.remove('bg-red-500');
                              downloadHDAllButton.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-green-400', 'hover:from-blue-600', 'hover:to-green-500');
                              downloadHDAllButton.disabled = false;
                         }, 2000);
                     }
                 };

                 // 直接使用 currentWallpaper 进行导出
                 performHDExport(currentWallpaper).then(() => {
                      // Promise resolved，操作完成，按钮状态已在 performHDExport 中处理
                 }).catch((error) => {
                      console.error('一键下载高清壁纸过程中发生错误:', error);
                      // 确保在发生未捕获的错误时也更新按钮状态
                       downloadHDAllButton.innerHTML = '<i class="fa-solid fa-times mr-2"></i> 导出失败';
                       downloadHDAllButton.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-green-400', 'hover:from-blue-600', 'hover:to-green-500');
                       downloadHDAllButton.classList.add('bg-red-500');
                       setTimeout(() => {
                           downloadHDAllButton.classList.remove('bg-red-500');
                           downloadHDAllButton.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-green-400', 'hover:from-blue-600', 'hover:to-green-500');
                           downloadHDAllButton.disabled = false;
                      }, 2000);
                 });
            });

            /**
             * 导出高清壁纸（等比例居中裁剪，电脑壁纸支持yOffset）
             * @param {HTMLImageElement} img - 原始壁纸图片
             * @param {number} targetWidth - 导出宽度
             * @param {number} targetHeight - 导出高度
             * @param {string} filename - 文件名
             * @param {number} [yOffset=0] - 仅电脑壁纸用，壁纸上下偏移
             * @returns {Promise<boolean>} - 返回一个Promise，表示导出是否成功
             */
            async function exportHDWallpaper(img, targetWidth, targetHeight, filename, yOffset = 0) {
                 console.log(`尝试导出高清壁纸: ${filename}`);
                const canvas = document.createElement('canvas');
                canvas.width = targetWidth;
                canvas.height = targetHeight;
                const ctx = canvas.getContext('2d');
                // 设置图像平滑
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                
                // 电脑壁纸导出时，内容区绘制逻辑与预览一致，防止顶部黑边
                if (targetWidth === 3840 && targetHeight === 2160) {
                    const imageRatio = img.width / img.height;
                    const screenRatio = targetWidth / targetHeight;
                    let drawWidth, drawHeight, drawX, drawY;
                    if (imageRatio > screenRatio) {
                        drawHeight = targetHeight;
                        drawWidth = drawHeight * imageRatio;
                        drawX = -(drawWidth - targetWidth) / 2;
                        drawY = - (drawHeight - targetHeight) / 2 + yOffset;
                    } else {
                        drawWidth = targetWidth;
                        drawHeight = drawWidth / imageRatio;
                        drawX = 0;
                        drawY = -(drawHeight - targetHeight) / 2 + yOffset;
                    }
                    ctx.drawImage(img, drawX, drawY, drawWidth, drawHeight);
                } else {
                    // 手机和平板壁纸导出，强制忽略yOffset，始终居中
                    const imgRatio = img.width / img.height;
                    const targetRatio = targetWidth / targetHeight;
                    let drawWidth, drawHeight, drawX, drawY;
                    if (imgRatio > targetRatio) {
                        drawHeight = targetHeight;
                        drawWidth = drawHeight * imgRatio;
                        drawX = -(drawWidth - targetWidth) / 2;
                        drawY = 0; // 不用yOffset
                    } else {
                        drawWidth = targetWidth;
                        drawHeight = drawWidth / imgRatio;
                        drawX = 0;
                        drawY = -(drawHeight - targetHeight) / 2; // 不用yOffset
                    }
                    ctx.drawImage(img, drawX, drawY, drawWidth, drawHeight);
                }

                // 改用 canvas.toBlob 导出
                return new Promise((resolve) => {
                     canvas.toBlob(function(blob) {
                         if (!blob || blob.size === 0) {
                             console.error('高清壁纸导出失败: 无法创建Blob或Blob为空。', blob);
                             alert(`导出高清壁纸失败: ${filename} 无法创建图片数据或数据为空。`);
                             resolve(false);
                             return;
                         }

                         console.log(`成功创建高清Blob，大小: ${blob.size} 字节，类型: ${blob.type}`);
                         const url = URL.createObjectURL(blob);
                         const link = document.createElement('a');
                         link.download = filename;
                         link.href = url;
                         document.body.appendChild(link);
                         link.click();
                         document.body.removeChild(link);

                         // 延迟释放URL对象
                         setTimeout(() => {
                             URL.revokeObjectURL(url);
                              console.log('释放高清Blob URL:', url);
                         }, 100);

                         resolve(true);

                     }, 'image/jpeg', 0.95); // 高清导出默认使用JPEG，质量0.95
                });
            }
            
            // 处理文件上传
            function handleFileUpload() {
                const file = wallpaperUpload.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    // 使用统一的加载函数处理本地上传的图片
                    loadAndDisplayWallpaper(e.target.result); // e.target.result 是blob: URL
                };
                reader.readAsDataURL(file);
            }
            
            // 绘制手机
            function drawPhone(wallpaper) {
                // 清除画布
                phoneCtx.clearRect(0, 0, phoneWidth, phoneHeight);
                
                // 绘制手机外壳（边框）
                phoneCtx.fillStyle = '#1C1C1E'; // 深空灰色
                roundRect(phoneCtx, 0, 0, phoneWidth, phoneHeight, phoneCornerRadius);
                phoneCtx.fill();
                
                // 绘制手机正面屏幕区域
                phoneCtx.fillStyle = '#000';
                roundRect(phoneCtx, phoneBezelWidth, phoneBezelWidth, phoneWidth - 2 * phoneBezelWidth, phoneHeight - 2 * phoneBezelWidth, phoneCornerRadius - 8);
                phoneCtx.fill();
                
                // 绘制屏幕内容（如果有壁纸则显示壁纸）
                if (wallpaper) {
                    // 计算壁纸缩放比例以适应屏幕并应用圆角
                    drawRoundedImage(phoneCtx, wallpaper, phoneBezelWidth * 1.5, phoneBezelWidth * 1.5, 
                                    phoneWidth - 3 * phoneBezelWidth, phoneHeight - 3 * phoneBezelWidth, 
                                    phoneCornerRadius - 10);
                } else {
                    // 没有壁纸时显示默认背景
                    phoneCtx.fillStyle = '#F9F9F9';
                    roundRect(phoneCtx, phoneBezelWidth * 1.5, phoneBezelWidth * 1.5, phoneWidth - 3 * phoneBezelWidth, phoneHeight - 3 * phoneBezelWidth, phoneCornerRadius - 10);
                    phoneCtx.fill();
                }
            }
            
            // 绘制平板
            function drawTablet(wallpaper) {
                // 清除画布
                tabletCtx.clearRect(0, 0, tabletWidth, tabletHeight);
                
                // 绘制平板外壳（边框）
                tabletCtx.fillStyle = '#1C1C1E'; // 深空灰色
                roundRect(tabletCtx, 0, 0, tabletWidth, tabletHeight, tabletCornerRadius);
                tabletCtx.fill();
                
                // 绘制平板正面屏幕区域
                tabletCtx.fillStyle = '#000';
                roundRect(tabletCtx, tabletBezelWidth, tabletBezelWidth, tabletWidth - 2 * tabletBezelWidth, tabletHeight - 2 * tabletBezelWidth, tabletCornerRadius - 5);
                tabletCtx.fill();
                
                // 绘制屏幕内容（如果有壁纸则显示壁纸）
                if (wallpaper) {
                    // 计算壁纸缩放比例以适应屏幕并应用圆角
                    drawRoundedImage(tabletCtx, wallpaper, tabletBezelWidth * 1.5, tabletBezelWidth * 1.5, 
                                    tabletWidth - 3 * tabletBezelWidth, tabletHeight - 3 * tabletBezelWidth, 
                                    tabletCornerRadius - 8);
                } else {
                    // 没有壁纸时显示默认背景
                    tabletCtx.fillStyle = '#F9F9F9';
                    roundRect(tabletCtx, tabletBezelWidth * 1.5, tabletBezelWidth * 1.5, tabletWidth - 3 * tabletBezelWidth, tabletHeight - 3 * tabletBezelWidth, tabletCornerRadius - 8);
                    tabletCtx.fill();
                }
            }
            
            // 绘制电脑
            function drawLaptop(wallpaper) {
                // 清除画布
                laptopCtx.clearRect(0, 0, laptopWidth, laptopHeight + laptopBaseHeight);
                
                // 绘制电脑屏幕边框
                laptopCtx.fillStyle = '#1C1C1E'; // 深空灰色
                roundRect(laptopCtx, 0, 0, laptopWidth, laptopHeight, 10);
                laptopCtx.fill();
                
                // 绘制电脑屏幕区域
                laptopCtx.fillStyle = '#000';
                roundRect(laptopCtx, laptopBezelWidth, laptopBezelWidth, laptopWidth - 2 * laptopBezelWidth, laptopScreenHeight - 2 * laptopBezelWidth, 5);
                laptopCtx.fill();
                
                // 绘制屏幕内容（如果有壁纸则显示壁纸）
                if (wallpaper) {
                    const screenWidth = laptopWidth - 3 * laptopBezelWidth;
                    const screenHeight = laptopScreenHeight - 3 * laptopBezelWidth;
                    const screenX = laptopBezelWidth * 1.5;
                    const screenY = laptopBezelWidth * 1.5;
                    drawWallpaperContentArea(laptopCtx, wallpaper, screenX, screenY, screenWidth, screenHeight, yOffset);
                } else {
                    // 没有壁纸时显示默认背景
                    laptopCtx.fillStyle = '#F9F9F9';
                    roundRect(laptopCtx, laptopBezelWidth * 1.5, laptopBezelWidth * 1.5, laptopWidth - 3 * laptopBezelWidth, laptopScreenHeight - 3 * laptopBezelWidth, 5);
                    laptopCtx.fill();
                }
                
                // 绘制电脑底座
                laptopCtx.fillStyle = '#2A2A2A';
                laptopCtx.fillRect(0, laptopHeight, laptopWidth, laptopBaseHeight);
                
                // 绘制底座凹槽
                laptopCtx.fillStyle = '#1A1A1A';
                laptopCtx.beginPath();
                laptopCtx.moveTo(laptopWidth * 0.2, laptopHeight);
                laptopCtx.bezierCurveTo(laptopWidth * 0.5, laptopHeight - 8, laptopWidth * 0.8, laptopHeight, laptopWidth * 0.8, laptopHeight);
                laptopCtx.lineTo(laptopWidth * 0.2, laptopHeight);
                laptopCtx.closePath();
                laptopCtx.fill();
            }
            
            // 绘制带圆角的图像
            function drawRoundedImage(ctx, img, x, y, width, height, radius) {
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(x + radius, y);
                ctx.lineTo(x + width - radius, y);
                ctx.arcTo(x + width, y, x + width, y + radius, radius);
                ctx.lineTo(x + width, y + height - radius);
                ctx.arcTo(x + width, y + height, x + width - radius, y + height, radius);
                ctx.lineTo(x + radius, y + height);
                ctx.arcTo(x, y + height, x, y + height - radius, radius);
                ctx.lineTo(x, y + radius);
                ctx.arcTo(x, y, x + radius, y, radius);
                ctx.closePath();
                ctx.clip();
                
                // 计算壁纸缩放比例以适应屏幕
                const imageRatio = img.width / img.height;
                const screenRatio = width / height;
                
                let drawWidth, drawHeight, drawX, drawY;
                
                if (imageRatio > screenRatio) {
                    // 图片比屏幕宽，等比例缩放高度
                    drawHeight = height;
                    drawWidth = drawHeight * imageRatio;
                    drawX = x - (drawWidth - width) / 2;
                    drawY = y;
                } else {
                    // 图片比屏幕高，等比例缩放宽度
                    drawWidth = width;
                    drawHeight = drawWidth / imageRatio;
                    // 居中显示图片
                    drawX = x;
                    drawY = y - (drawHeight - height) / 2;
                }
                
                ctx.drawImage(img, drawX, drawY, drawWidth, drawHeight);
                ctx.restore();
            }
            
            // 绘制圆角矩形
            function roundRect(ctx, x, y, width, height, radius) {
                ctx.beginPath();
                ctx.moveTo(x + radius, y);
                ctx.lineTo(x + width - radius, y);
                ctx.arcTo(x + width, y, x + width, y + radius, radius);
                ctx.lineTo(x + width, y + height - radius);
                ctx.arcTo(x + width, y + height, x + width - radius, y + height, radius);
                ctx.lineTo(x + radius, y + height);
                ctx.arcTo(x, y + height, x, y + height - radius, radius);
                ctx.lineTo(x, y + radius);
                ctx.arcTo(x, y, x + radius, y, radius);
                ctx.closePath();
            }
            
            // 绘制手机状态栏
            function drawPhoneStatusBar() {
                phoneCtx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                phoneCtx.fillRect(phoneBezelWidth * 1.5, phoneBezelWidth * 1.5, phoneWidth - 3 * phoneBezelWidth, 30);
                
                // 绘制时间
                phoneCtx.fillStyle = '#FFF';
                phoneCtx.font = 'bold 14px Inter';
                phoneCtx.textAlign = 'center';
                phoneCtx.fillText('9:41', phoneWidth / 2, phoneBezelWidth * 1.5 + 20);
                
                // 绘制信号、电池等图标（简化版）
                phoneCtx.fillStyle = '#FFF';
                phoneCtx.font = '12px Font Awesome 6 Free';
                phoneCtx.textAlign = 'right';
                phoneCtx.fillText('\uf1eb \uf2f1 \uf240', phoneWidth - phoneBezelWidth * 2, phoneBezelWidth * 1.5 + 20);
            }
            
            // 绘制手机底部指示条
            function drawPhoneHomeIndicator() {
                phoneCtx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                phoneCtx.beginPath();
                phoneCtx.roundRect(phoneWidth / 2 - 60, phoneHeight - phoneBezelWidth * 3, 120, 5, 2.5);
                phoneCtx.fill();
            }
            
            // 绘制平板状态栏
            function drawTabletStatusBar() {
                tabletCtx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                tabletCtx.fillRect(tabletBezelWidth * 1.5, tabletBezelWidth * 1.5, tabletWidth - 3 * tabletBezelWidth, 40);
                
                // 绘制时间
                tabletCtx.fillStyle = '#FFF';
                tabletCtx.font = 'bold 16px Inter';
                tabletCtx.textAlign = 'center';
                tabletCtx.fillText('9:41', tabletWidth / 2, tabletBezelWidth * 1.5 + 25);
                
                // 绘制信号、电池等图标（简化版）
                tabletCtx.fillStyle = '#FFF';
                tabletCtx.font = '14px Font Awesome 6 Free';
                tabletCtx.textAlign = 'right';
                tabletCtx.fillText('\uf1eb \uf2f1 \uf240', tabletWidth - tabletBezelWidth * 2, tabletBezelWidth * 1.5 + 25);
            }
            
            // 绘制电脑任务栏
            function drawLaptopTaskbar() {
                const taskbarHeight = 40;
                laptopCtx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                laptopCtx.fillRect(laptopBezelWidth * 1.5, laptopScreenHeight - taskbarHeight - laptopBezelWidth * 1.5, 
                                  laptopWidth - 3 * laptopBezelWidth, taskbarHeight);
                
                // 绘制开始按钮
                laptopCtx.fillStyle = '#165DFF';
                laptopCtx.beginPath();
                laptopCtx.arc(laptopBezelWidth * 3, laptopScreenHeight - taskbarHeight/2 - laptopBezelWidth * 1.5, 15, 0, Math.PI * 2);
                laptopCtx.fill();
                
                // 绘制开始按钮图标
                laptopCtx.fillStyle = '#FFF';
                laptopCtx.font = '20px Font Awesome 6 Free';
                laptopCtx.textAlign = 'center';
                laptopCtx.fillText('\uf11b', laptopBezelWidth * 3, laptopScreenHeight - taskbarHeight/2 - laptopBezelWidth * 1.5 + 7);
                
                // 绘制任务栏图标
                const taskbarIcons = [
                    '\uf1c9', '\uf0c3', '\uf0e0', '\uf17a'
                ];
                
                taskbarIcons.forEach((icon, index) => {
                    laptopCtx.fillStyle = '#FFF';
                    laptopCtx.font = '20px Font Awesome 6 Free';
                    laptopCtx.textAlign = 'center';
                    laptopCtx.fillText(icon, laptopBezelWidth * 6 + index * 50, laptopScreenHeight - taskbarHeight/2 - laptopBezelWidth * 1.5 + 7);
                });
                
                // 绘制系统托盘
                laptopCtx.fillStyle = '#FFF';
                laptopCtx.font = '14px Font Awesome 6 Free';
                laptopCtx.textAlign = 'right';
                laptopCtx.fillText('\uf028 \uf1eb \uf240 9:41', laptopWidth - laptopBezelWidth * 3, laptopScreenHeight - taskbarHeight/2 - laptopBezelWidth * 1.5 + 5);
            }
            
            // 绘制内容区壁纸（预览和导出都用这个）
            function drawWallpaperContentArea(ctx, img, x, y, w, h, yOffset = 0) {
                const imageRatio = img.width / img.height;
                const screenRatio = w / h;
                let drawWidth, drawHeight, drawX, drawY;
                if (imageRatio > screenRatio) {
                    drawHeight = h;
                    drawWidth = drawHeight * imageRatio;
                    drawX = x - (drawWidth - w) / 2;
                    drawY = y + yOffset;
                } else {
                    drawWidth = w;
                    drawHeight = drawWidth / imageRatio;
                    drawX = x;
                    drawY = y - (drawHeight - h) / 2 + yOffset;
                }
                ctx.drawImage(img, drawX, drawY, drawWidth, drawHeight);
            }
            
            // 下载预览图
            async function downloadPreview(canvas, filename, deviceType) {
                // 检查壁纸是否加载完成
                if (!currentWallpaper || !currentWallpaper.complete || currentWallpaper.naturalWidth === 0) {
                    alert('壁纸未加载完成，无法下载！');
                    return;
                }
                let button;
                switch(filename) {
                    case '手机':
                        button = downloadPhoneButton;
                        break;
                    case '平板':
                        button = downloadTabletButton;
                        break;
                    case '电脑':
                        button = downloadLaptopButton;
                        break;
                    default:
                        return;
                }
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> 下载中...';
                button.disabled = true;
                try {
                    // 只下载"带外观的壁纸"
                    if (canvas === phoneCanvas) drawPhone(currentWallpaper);
                    if (canvas === tabletCanvas) drawTablet(currentWallpaper);
                    if (canvas === laptopCanvas) drawLaptop(currentWallpaper);
                    
                    // 调用 exportCanvasAsImage 并等待结果
                    const downloadSuccess = await exportCanvasAsImage(canvas, filename + '.png');

                    if (downloadSuccess) {
                         // 更新按钮状态为下载成功
                        button.innerHTML = '<i class="fa-solid fa-check mr-2"></i> 下载成功';
                        button.classList.remove('bg-accent', 'bg-secondary', 'bg-primary');
                        button.classList.add('bg-green-500');
                        setTimeout(() => {
                            button.innerHTML = originalText;
                            button.classList.remove('bg-green-500');
                            if (filename === '手机') {
                                button.classList.add('bg-accent');
                            } else if (filename === '平板') {
                                button.classList.add('bg-secondary');
                            } else {
                                button.classList.add('bg-primary');
                            }
                            button.disabled = false;
                        }, 2000);
                    } else {
                        // 更新按钮状态为下载失败
                         button.innerHTML = '<i class="fa-solid fa-times mr-2"></i> 下载失败';
                         button.classList.remove('bg-accent', 'bg-secondary', 'bg-primary');
                         button.classList.add('bg-red-500');
                         setTimeout(() => {
                             button.innerHTML = originalText;
                             button.classList.remove('bg-red-500');
                             if (filename === '手机') {
                                 button.classList.add('bg-accent');
                             } else if (filename === '平板') {
                                 button.classList.add('bg-secondary');
                             } else {
                                 button.classList.add('bg-primary');
                             }
                             button.disabled = false;
                         }, 2000);
                    }

                } catch (error) {
                    console.error('下载失败:', error);
                    // 更新按钮状态为下载失败
                    button.innerHTML = '<i class="fa-solid fa-times mr-2"></i> 下载失败';
                    button.classList.remove('bg-accent', 'bg-secondary', 'bg-primary');
                    button.classList.add('bg-red-500');
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.classList.remove('bg-red-500');
                        if (filename === '手机') {
                            button.classList.add('bg-accent');
                        } else if (filename === '平板') {
                            button.classList.add('bg-secondary');
                        } else {
                            button.classList.add('bg-primary');
                        }
                        button.disabled = false;
                    }, 2000);
                }
            }

            // 导出canvas为图片
            /**
             * 导出canvas为图片文件
             * @param {HTMLCanvasElement} canvas - 要导出的Canvas元素
             * @param {string} filename - 下载文件的名称
             * @param {string} [format='image/jpeg'] - 输出的图片格式 (e.g., 'image/jpeg', 'image/png')，默认为 image/jpeg
             * @param {number} [quality=0.95] - 输出图片的质量 (仅适用于支持有损压缩的格式如 JPEG, 0.0 到 1.0)，默认为 0.95
             * @returns {Promise<boolean>} - 返回一个Promise，表示导出是否成功
             */
            async function exportCanvasAsImage(canvas, filename, format = 'image/jpeg', quality = 0.95) {
                console.log(`尝试导出文件: ${filename}, 格式: ${format}, 质量: ${quality}`);
                return new Promise((resolve) => {
                    canvas.toBlob(function(blob) {
                        if (!blob || blob.size === 0) {
                            console.error('Canvas导出失败: 无法创建Blob或Blob为空。', blob);
                            alert('导出失败：无法创建图片数据或数据为空。');
                            resolve(false); // 导出失败
                            return;
                        }
                        
                        console.log(`成功创建Blob，大小: ${blob.size} 字节，类型: ${blob.type}`);

                        const url = URL.createObjectURL(blob);
                        console.log('创建Blob URL:', url);
                        const link = document.createElement('a');
                        link.download = filename;
                        link.href = url;
                        
                        // 尝试触发下载
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);

                        // 延迟释放URL对象，给浏览器一点时间处理下载
                        setTimeout(() => {
                            URL.revokeObjectURL(url);
                            console.log('释放Blob URL:', url);
                        }, 100); // 延迟100ms释放

                        resolve(true); // 假定点击链接会触发下载，标记导出成功

                    }, format, quality);
                });
            }

            // 添加壁纸位置调整功能
            moveUpBtn.addEventListener('click', function() {
                if (yOffset > 0) {
                    yOffset -= 10;
                    updateOffsetDisplay();
                    if (currentWallpaper) {
                        // 更新电脑壁纸位置
                        drawLaptop(currentWallpaper);
                        // 更新预览图位置
                        previewImage.style.objectPosition = `center -${yOffset}px`;
                    }
                }
            });
            
            moveDownBtn.addEventListener('click', function() {
                yOffset += 10;
                updateOffsetDisplay();
                if (currentWallpaper) {
                    // 更新电脑壁纸位置
                    drawLaptop(currentWallpaper);
                    // 更新预览图位置
                    previewImage.style.objectPosition = `center -${yOffset}px`;
                }
            });
            
            function updateOffsetDisplay() {
                offsetValue.textContent = `偏移: ${yOffset}px`;
            }

            // 绘制微信头像
            /**
             * 绘制微信头像
             * @param {CanvasRenderingContext2D} ctx - Canvas上下文
             * @param {HTMLImageElement} img - 壁纸图片
             * @param {boolean} [isRound=true] - 是否绘制圆形头像
             * @param {number} [yOffset=0] - 壁纸上下偏移量
             * @param {number} [compensationOffset=0] - 额外的上下偏移补偿
             */
            function drawAvatar(ctx, img, isRound = true, yOffset = 0, compensationOffset = 0) {
                // 获取当前Canvas的实际尺寸
                const canvasWidth = ctx.canvas.width;
                const canvasHeight = ctx.canvas.height;
                
                // 清除画布，使用Canvas的实际尺寸
                ctx.clearRect(0, 0, canvasWidth, canvasHeight);
                
                ctx.save(); // 保存当前状态，以便绘制和裁剪后恢复
                
                if (isRound) {
                    // 创建圆形裁剪区域，使用Canvas的实际尺寸计算中心和半径
                    const radius = Math.min(canvasWidth, canvasHeight) / 2;
                    ctx.beginPath();
                    ctx.arc(canvasWidth / 2, canvasHeight / 2, radius, 0, Math.PI * 2);
                    ctx.clip();
                } else {
                    // 创建圆角矩形裁剪区域，使用Canvas的实际尺寸和等比例缩放的圆角半径
                    const targetRadius = avatarSize.roundRadius * (canvasWidth / avatarSize.width); // 圆角半径也等比例缩放
                    ctx.beginPath();
                    roundRect(ctx, 0, 0, canvasWidth, canvasHeight, targetRadius);
                    ctx.clip();
                }
                
                // 计算图片缩放和位置，使其居中填充整个Canvas区域
                const scale = Math.max(
                    canvasWidth / img.width,
                    canvasHeight / img.height
                );
                
                const x = (canvasWidth - img.width * scale) / 2;
                const y = (canvasHeight - img.height * scale) / 2 + yOffset + compensationOffset; // 应用yOffset和补偿偏移量
                
                ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                
                ctx.restore(); // 恢复到裁剪之前的状态
            }
            
            // 下载微信头像
            async function downloadAvatar() {
                if (!currentWallpaper || !currentWallpaper.complete || currentWallpaper.naturalWidth === 0) {
                    alert('壁纸未加载完成，无法下载！');
                    return;
                }
                const originalText = downloadAvatarButton.innerHTML;
                downloadAvatarButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> 下载中...';
                downloadAvatarButton.disabled = true;
                try {
                    // 下载圆形头像，使用PNG格式以保留透明背景
                    const roundCanvas = document.createElement('canvas');
                    // 分辨率提升2倍
                    roundCanvas.width = avatarSize.width * 2;
                    roundCanvas.height = avatarSize.height * 2;
                    const roundCtx = roundCanvas.getContext('2d');
                    // 在提升分辨率的Canvas上绘制头像，传入yOffset和补偿偏移量
                    drawAvatar(roundCtx, currentWallpaper, true, yOffset, -70); // 应用偏移补偿
                    // 导出为PNG格式以保留透明背景
                    const roundSuccess = await exportCanvasAsImage(roundCanvas, '圆形头像.png', 'image/png'); // 指定 PNG 格式

                    // 下载圆角方形头像，使用PNG格式以保留透明背景
                    const squareCanvas = document.createElement('canvas');
                     // 分辨率提升2倍
                    squareCanvas.width = avatarSize.width * 2;
                    squareCanvas.height = avatarSize.height * 2;
                    const squareCtx = squareCanvas.getContext('2d');
                     // 在提升分辨率的Canvas上绘制头像，传入yOffset和补偿偏移量
                    drawAvatar(squareCtx, currentWallpaper, false, yOffset, -70); // 应用偏移补偿
                    // 导出为PNG格式以保留透明背景
                    const squareSuccess = await exportCanvasAsImage(squareCanvas, '方形头像.png', 'image/png'); // 指定 PNG 格式

                    if (roundSuccess && squareSuccess) {
                         downloadAvatarButton.innerHTML = '<i class="fa-solid fa-check mr-2"></i> 下载成功';
                         downloadAvatarButton.classList.remove('bg-green-500');
                         downloadAvatarButton.classList.add('bg-green-600');
                         setTimeout(() => {
                             downloadAvatarButton.innerHTML = originalText;
                             downloadAvatarButton.classList.remove('bg-green-600');
                             downloadAvatarButton.classList.add('bg-green-500');
                             downloadAvatarButton.disabled = false;
                         }, 2000);
                    } else {
                         downloadAvatarButton.innerHTML = '<i class="fa-solid fa-times mr-2"></i> 下载失败';
                         downloadAvatarButton.classList.remove('bg-green-500');
                         downloadAvatarButton.classList.add('bg-red-500');
                         setTimeout(() => {
                             downloadAvatarButton.innerHTML = originalText;
                             downloadAvatarButton.classList.remove('bg-red-500');
                             downloadAvatarButton.classList.add('bg-green-500');
                             downloadAvatarButton.disabled = false;
                         }, 2000);
                    }

                } catch (error) {
                    console.error('下载失败:', error);
                    downloadAvatarButton.innerHTML = '<i class="fa-solid fa-times mr-2"></i> 下载失败';
                    downloadAvatarButton.classList.remove('bg-green-500');
                    downloadAvatarButton.classList.add('bg-red-500');
                    setTimeout(() => {
                        downloadAvatarButton.innerHTML = originalText;
                        downloadAvatarButton.classList.remove('bg-red-500');
                        downloadAvatarButton.classList.add('bg-green-500');
                        downloadAvatarButton.disabled = false;
                    }, 2000);
                }
            }
            
            // 下载朋友圈封面
            async function downloadCover() {
                if (!currentWallpaper || !currentWallpaper.complete || currentWallpaper.naturalWidth === 0) {
                    alert('壁纸未加载完成，无法下载！');
                    return;
                }
                const originalText = downloadCoverButton.innerHTML;
                downloadCoverButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> 下载中...';
                downloadCoverButton.disabled = true;
                try {
                    // 新建临时canvas，宽高用最新momentWidth和momentHeight
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = momentWidth;
                    tempCanvas.height = momentHeight;
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCtx.save();
                    roundRect(tempCtx, 0, 0, momentWidth, momentHeight, 20);
                    tempCtx.clip();
                    // 绘制壁纸
                    if (currentWallpaper) {
                        const imageRatio = currentWallpaper.width / currentWallpaper.height;
                        const screenRatio = momentWidth / momentHeight;
                        let drawWidth, drawHeight, drawX, drawY;
                        if (imageRatio > screenRatio) {
                            drawHeight = momentHeight;
                            drawWidth = drawHeight * imageRatio;
                            drawX = -(drawWidth - momentWidth) / 2;
                            drawY = yOffset; // 使用yOffset
                        } else {
                            drawWidth = momentWidth;
                            drawHeight = drawWidth / imageRatio;
                            drawX = 0;
                            drawY = -(drawHeight - momentHeight) / 2 + yOffset; // 使用yOffset
                        }
                        tempCtx.drawImage(currentWallpaper, drawX, drawY, drawWidth, drawHeight);
                    } else {
                        tempCtx.fillStyle = '#EEE';
                        tempCtx.fillRect(0, 0, momentWidth, momentHeight);
                    }
                    // 底部白色栏
                    tempCtx.fillStyle = '#fff';
                    tempCtx.fillRect(0, momentHeight - momentBarHeight, momentWidth, momentBarHeight);
                    // 底部白色栏左侧说明文字
                    tempCtx.save();
                    tempCtx.font = 'bold 16px sans-serif'; // 避免自定义字体导致异常
                    tempCtx.fillStyle = 'rgba(120,120,120,0.85)';
                    tempCtx.textAlign = 'left';
                    tempCtx.textBaseline = 'middle';
                    tempCtx.shadowColor = 'rgba(255,255,255,0.7)';
                    tempCtx.shadowBlur = 4;
                    tempCtx.fillText('朋友圈封面预览+头像', 24, momentHeight - momentBarHeight/2);
                    tempCtx.restore();
                    // 右下角头像框
                    const avatarX = momentWidth - momentAvatarSize - momentAvatarMargin;
                    const avatarY = momentHeight - momentBarHeight/2 - momentAvatarSize/2;
                    tempCtx.save();
                    roundRect(tempCtx, avatarX, avatarY, momentAvatarSize, momentAvatarSize, momentAvatarRadius);
                    tempCtx.clip();
                    if (currentWallpaper && currentWallpaper.complete) {
                        const scale = Math.max(momentAvatarSize / currentWallpaper.width, momentAvatarSize / currentWallpaper.height);
                        const ax = avatarX + (momentAvatarSize - currentWallpaper.width * scale) / 2;
                        const ay = avatarY + (momentAvatarSize - currentWallpaper.height * scale) / 2; // 移除yOffset应用，头像固定在右下角
                        tempCtx.drawImage(currentWallpaper, ax, ay, currentWallpaper.width * scale, currentWallpaper.height * scale);
                    } else {
                        tempCtx.fillStyle = '#CCC';
                        tempCtx.fillRect(avatarX, avatarY, momentAvatarSize, momentAvatarSize);
                    }
                    tempCtx.restore();
                    // 昵称
                    tempCtx.font = 'bold 36px sans-serif'; // 避免自定义字体导致异常
                    tempCtx.fillStyle = '#222';
                    tempCtx.textAlign = 'right';
                    tempCtx.textBaseline = 'middle';
                    tempCtx.fillText(momentName, avatarX - 20, momentHeight - momentBarHeight/2);
                    // 相机icon（右上角）
                    tempCtx.save();
                    if (typeof cameraIconImg !== 'undefined' && cameraIconImg.complete && cameraIconImg.naturalWidth > 0) {
                        tempCtx.drawImage(cameraIconImg, momentWidth - 40 - 16, 40 - 16, 32, 32);
                    }
                    tempCtx.restore();
                    // 边框
                    tempCtx.save();
                    roundRect(tempCtx, 0.5, 0.5, momentWidth-1, momentHeight-1, 20);
                    tempCtx.strokeStyle = '#e5e7eb';
                    tempCtx.lineWidth = 4;
                    tempCtx.stroke();
                    tempCtx.restore();
                    // 导出图片
                    const coverSuccess = await exportCanvasAsImage(tempCanvas, '朋友圈预览.png');

                    if (coverSuccess) {
                         downloadCoverButton.innerHTML = '<i class="fa-solid fa-check mr-2"></i> 下载成功';
                         downloadCoverButton.classList.remove('bg-blue-500');
                         downloadCoverButton.classList.add('bg-blue-600');
                         setTimeout(() => {
                             downloadCoverButton.innerHTML = originalText;
                             downloadCoverButton.classList.remove('bg-blue-600');
                             downloadCoverButton.classList.add('bg-blue-500');
                             downloadCoverButton.disabled = false;
                         }, 2000);
                    } else {
                         downloadCoverButton.innerHTML = '<i class="fa-solid fa-times mr-2"></i> 下载失败';
                         downloadCoverButton.classList.remove('bg-blue-500');
                         downloadCoverButton.classList.add('bg-red-500');
                         setTimeout(() => {
                             downloadCoverButton.innerHTML = originalText;
                             downloadCoverButton.classList.remove('bg-red-500');
                             downloadCoverButton.classList.add('bg-blue-500');
                             downloadCoverButton.disabled = false;
                         }, 2000);
                    }

                } catch (error) {
                    console.error('下载失败:', error);
                    alert('下载失败：' + error.message);
                    downloadCoverButton.innerHTML = '<i class="fa-solid fa-times mr-2"></i> 下载失败';
                    downloadCoverButton.classList.remove('bg-blue-500');
                    downloadCoverButton.classList.add('bg-red-500');
                    setTimeout(() => {
                        downloadCoverButton.innerHTML = originalText;
                        downloadCoverButton.classList.remove('bg-red-500');
                        downloadCoverButton.classList.add('bg-blue-500');
                        downloadCoverButton.disabled = false;
                    }, 2000);
                }
            }
            
            // 组合下载
            async function downloadBoth() {
                if (!currentWallpaper || !currentWallpaper.complete || currentWallpaper.naturalWidth === 0) {
                    alert('壁纸未加载完成，无法下载！');
                    return;
                }
                const originalText = downloadBothButton.innerHTML;
                downloadBothButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> 下载中...';
                downloadBothButton.disabled = true;
                try {
                    // === 下载圆形头像 (尺寸 600x600) ===
                    const avatarRoundCanvas = document.createElement('canvas');
                    avatarRoundCanvas.width = avatarSize.width * 2;
                    avatarRoundCanvas.height = avatarSize.height * 2;
                    const avatarRoundCtx = avatarRoundCanvas.getContext('2d');
                    // 在提升分辨率的Canvas上绘制头像，传入yOffset和补偿偏移量
                    drawAvatar(avatarRoundCtx, currentWallpaper, true, yOffset, -70); // 应用偏移补偿
                    // 导出为PNG格式以保留透明背景
                    const roundSuccess = await exportCanvasAsImage(avatarRoundCanvas, '圆形头像.png');

                    // === 下载圆角方形头像 (尺寸 600x600) ===
                    const avatarSquareCanvas = document.createElement('canvas');
                    // 分辨率提升2倍
                    avatarSquareCanvas.width = avatarSize.width * 2;
                    avatarSquareCanvas.height = avatarSize.height * 2;
                    const avatarSquareCtx = avatarSquareCanvas.getContext('2d');
                    // 在提升分辨率的Canvas上绘制头像，传入yOffset和补偿偏移量
                    drawAvatar(avatarSquareCtx, currentWallpaper, false, yOffset, -70); // 应用偏移补偿
                    // 导出为PNG格式以保留透明背景
                    const squareSuccess = await exportCanvasAsImage(avatarSquareCanvas, '方形头像.png');

                    // === 下载朋友圈完整预览 (封面，已支持yOffset) ===
                    // 新建临时canvas，宽高用最新momentWidth和momentHeight
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = momentWidth;
                    tempCanvas.height = momentHeight;
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCtx.save();
                    roundRect(tempCtx, 0, 0, momentWidth, momentHeight, 20);
                    tempCtx.clip();
                    // 绘制壁纸
                    if (currentWallpaper) {
                        const imageRatio = currentWallpaper.width / currentWallpaper.height;
                        const screenRatio = momentWidth / momentHeight;
                        let drawWidth, drawHeight, drawX, drawY;
                        if (imageRatio > screenRatio) {
                            drawHeight = momentHeight;
                            drawWidth = drawHeight * imageRatio;
                            drawX = -(drawWidth - momentWidth) / 2;
                            drawY = yOffset; // 使用yOffset
                        } else {
                            drawWidth = momentWidth;
                            drawHeight = drawWidth / imageRatio;
                            drawX = 0;
                            drawY = -(drawHeight - momentHeight) / 2 + yOffset; // 使用yOffset
                        }
                        tempCtx.drawImage(currentWallpaper, drawX, drawY, drawWidth, drawHeight);
                    } else {
                        tempCtx.fillStyle = '#EEE';
                        tempCtx.fillRect(0, 0, momentWidth, momentHeight);
                    }
                    // 底部白色栏
                    tempCtx.fillStyle = '#fff';
                    tempCtx.fillRect(0, momentHeight - momentBarHeight, momentWidth, momentBarHeight);
                    // 底部白色栏左侧说明文字
                    tempCtx.save();
                    tempCtx.font = 'bold 16px sans-serif'; // 避免自定义字体导致异常
                    tempCtx.fillStyle = 'rgba(120,120,120,0.85)';
                    tempCtx.textAlign = 'left';
                    tempCtx.textBaseline = 'middle';
                    tempCtx.shadowColor = 'rgba(255,255,255,0.7)';
                    tempCtx.shadowBlur = 4;
                    tempCtx.fillText('朋友圈封面预览+头像', 24, momentHeight - momentBarHeight/2);
                    tempCtx.restore();
                    // 右下角头像框
                    const avatarX = momentWidth - momentAvatarSize - momentAvatarMargin;
                    const avatarY = momentHeight - momentBarHeight/2 - momentAvatarSize/2;
                    tempCtx.save();
                    roundRect(tempCtx, avatarX, avatarY, momentAvatarSize, momentAvatarSize, momentAvatarRadius);
                    tempCtx.clip();
                    if (currentWallpaper && currentWallpaper.complete) {
                        const scale = Math.max(momentAvatarSize / currentWallpaper.width, momentAvatarSize / currentWallpaper.height);
                        const ax = avatarX + (momentAvatarSize - currentWallpaper.width * scale) / 2;
                        const ay = avatarY + (momentAvatarSize - currentWallpaper.height * scale) / 2; // 移除yOffset应用，头像固定在右下角
                        tempCtx.drawImage(currentWallpaper, ax, ay, currentWallpaper.width * scale, currentWallpaper.height * scale);
                    } else {
                        tempCtx.fillStyle = '#CCC';
                        tempCtx.fillRect(avatarX, avatarY, momentAvatarSize, momentAvatarSize);
                    }
                    tempCtx.restore();
                    // 昵称
                    tempCtx.font = 'bold 36px sans-serif'; // 避免自定义字体导致异常
                    tempCtx.fillStyle = '#222';
                    tempCtx.textAlign = 'right';
                    tempCtx.textBaseline = 'middle';
                    tempCtx.fillText(momentName, avatarX - 20, momentHeight - momentBarHeight/2);
                    // 相机icon（右上角）
                    tempCtx.save();
                    if (typeof cameraIconImg !== 'undefined' && cameraIconImg.complete && cameraIconImg.naturalWidth > 0) {
                        tempCtx.drawImage(cameraIconImg, momentWidth - 40 - 16, 40 - 16, 32, 32);
                    }
                    tempCtx.restore();
                    // 边框
                    tempCtx.save();
                    roundRect(tempCtx, 0.5, 0.5, momentWidth-1, momentHeight-1, 20);
                    tempCtx.strokeStyle = '#e5e7eb';
                    tempCtx.lineWidth = 4;
                    tempCtx.stroke();
                    tempCtx.restore();
                    // 导出图片
                    const coverSuccess = await exportCanvasAsImage(tempCanvas, '朋友圈预览.png');

                    if (roundSuccess && squareSuccess && coverSuccess) {
                         // 所有下载完成后更新按钮状态
                         downloadBothButton.innerHTML = '<i class="fa-solid fa-check mr-2"></i> 下载成功';
                         downloadBothButton.classList.remove('bg-purple-500');
                         downloadBothButton.classList.add('bg-purple-600');
                         setTimeout(() => {
                             downloadBothButton.innerHTML = originalText;
                             downloadBothButton.classList.remove('bg-purple-600');
                             downloadBothButton.classList.add('bg-purple-500');
                             downloadBothButton.disabled = false;
                         }, 2000);
                    } else {
                         downloadBothButton.innerHTML = '<i class="fa-solid fa-times mr-2"></i> 下载失败';
                         downloadBothButton.classList.remove('bg-purple-500');
                         downloadBothButton.classList.add('bg-red-500');
                         setTimeout(() => {
                             downloadBothButton.innerHTML = originalText;
                             downloadBothButton.classList.remove('bg-red-500');
                             downloadBothButton.classList.add('bg-purple-500');
                             downloadBothButton.disabled = false;
                         }, 2000);
                    }

                } catch (error) {
                    console.error('下载失败:', error);
                    downloadBothButton.innerHTML = '<i class="fa-solid fa-times mr-2"></i> 下载失败';
                    downloadBothButton.classList.remove('bg-purple-500');
                    downloadBothButton.classList.add('bg-red-500');
                    setTimeout(() => {
                        downloadBothButton.innerHTML = originalText;
                        downloadBothButton.classList.remove('bg-red-500');
                        downloadBothButton.classList.add('bg-purple-500');
                        downloadBothButton.disabled = false;
                    }, 2000);
                }
            }

            // 绘制朋友圈封面预览
            /**
             * 绘制朋友圈封面预览
             * @param {HTMLImageElement} wallpaper - 壁纸图片
             * @param {HTMLImageElement} avatarImg - 头像图片
             * @param {number} yOffset - 壁纸上下偏移量
             */
            function drawMomentPreview(wallpaper, avatarImg, yOffset = 0) {
                // 先裁切圆角矩形
                momentCtx.clearRect(0, 0, momentWidth, momentHeight);
                momentCtx.save();
                momentCtx.beginPath();
                roundRect(momentCtx, 0, 0, momentWidth, momentHeight, 20);
                momentCtx.clip();
                // 绘制壁纸，直接填满canvas
                if (wallpaper) {
                    const imageRatio = wallpaper.width / wallpaper.height;
                    const screenRatio = momentWidth / momentHeight;
                    let drawWidth, drawHeight, drawX, drawY;
                    if (imageRatio > screenRatio) {
                        drawHeight = momentHeight;
                        drawWidth = drawHeight * imageRatio;
                        drawX = -(drawWidth - momentWidth) / 2;
                        drawY = yOffset; // 应用yOffset
                    } else {
                        drawWidth = momentWidth;
                        drawHeight = drawWidth / imageRatio;
                        drawX = 0;
                        drawY = -(drawHeight - momentHeight) / 2 + yOffset; // 应用yOffset
                    }
                    momentCtx.drawImage(wallpaper, drawX, drawY, drawWidth, drawHeight);
                } else {
                    momentCtx.fillStyle = '#EEE';
                    momentCtx.fillRect(0, 0, momentWidth, momentHeight);
                }
                // 底部白色栏
                momentCtx.fillStyle = '#fff';
                momentCtx.fillRect(0, momentHeight - momentBarHeight, momentWidth, momentBarHeight);
                // 底部白色栏左侧说明文字
                momentCtx.save();
                momentCtx.font = 'bold 16px Inter, sans-serif';
                momentCtx.fillStyle = 'rgba(120,120,120,0.85)';
                momentCtx.textAlign = 'left';
                momentCtx.textBaseline = 'middle';
                momentCtx.shadowColor = 'rgba(255,255,255,0.7)';
                momentCtx.shadowBlur = 4;
                momentCtx.fillText('朋友圈封面预览+头像', 24, momentHeight - momentBarHeight/2);
                momentCtx.restore();
                // 右下角头像框
                const avatarX = momentWidth - momentAvatarSize - momentAvatarMargin;
                const avatarY = momentHeight - momentBarHeight/2 - momentAvatarSize/2;
                momentCtx.save();
                momentCtx.beginPath();
                roundRect(momentCtx, avatarX, avatarY, momentAvatarSize, momentAvatarSize, momentAvatarRadius);
                momentCtx.clip();
                if (avatarImg && avatarImg.complete) {
                    const scale = Math.max(momentAvatarSize / avatarImg.width, momentAvatarSize / avatarImg.height);
                    const ax = avatarX + (momentAvatarSize - avatarImg.width * scale) / 2;
                    const ay = avatarY + (momentAvatarSize - avatarImg.height * scale) / 2; // 移除yOffset应用，头像固定在右下角
                    momentCtx.drawImage(avatarImg, ax, ay, avatarImg.width * scale, avatarImg.height * scale);
                } else {
                    momentCtx.fillStyle = '#CCC';
                    momentCtx.fillRect(avatarX, avatarY, momentAvatarSize, momentAvatarSize);
                }
                momentCtx.restore();
                // 昵称
                momentCtx.font = 'bold 36px Inter, sans-serif'; // 确认字体设置
                momentCtx.fillStyle = '#222';
                momentCtx.textAlign = 'right';
                momentCtx.textBaseline = 'middle';
                momentCtx.fillText(momentName, avatarX - 20, momentHeight - momentBarHeight/2);
                // 相机icon
                momentCtx.save();
                // 只绘制透明PNG，不绘制背景
                if (cameraIconImg.complete && cameraIconImg.naturalWidth > 0) {
                    momentCtx.drawImage(cameraIconImg, momentWidth - 40 - 16, 40 - 16, 32, 32);
                } else {
                     console.warn('Camera icon image not loaded or invalid for full preview.'); // 添加警告
                     // 可以选择在这里绘制一个占位符或文字提示
                }
                momentCtx.restore();
                // 最后画一圈圆角边框
                momentCtx.save();
                momentCtx.beginPath();
                roundRect(momentCtx, 0.5, 0.5, momentWidth-1, momentHeight-1, 20);
                momentCtx.strokeStyle = '#e5e7eb';
                momentCtx.lineWidth = 4;
                momentCtx.stroke();
                momentCtx.restore();
            }

            // 新增朋友圈完整预览截图
            const momentFullCanvas = document.createElement('canvas');
            momentFullCanvas.width = momentWidth;
            momentFullCanvas.height = momentHeight;
            const momentFullCtx = momentFullCanvas.getContext('2d');
            // 绘制完整朋友圈预览截图
            /**
             * 绘制完整朋友圈预览截图
             * @param {HTMLImageElement} wallpaper - 壁纸图片
             * @param {HTMLImageElement} avatarImg - 头像图片
             * @param {number} yOffset - 壁纸上下偏移量
             */
            function drawMomentFullPreview(wallpaper, avatarImg, yOffset = 0) {
                momentFullCanvas.width = momentWidth;
                momentFullCanvas.height = momentHeight;
                momentFullCtx.clearRect(0, 0, momentWidth, momentHeight);
                momentFullCtx.save();
                momentFullCtx.beginPath();
                roundRect(momentFullCtx, 0, 0, momentWidth, momentHeight, 20);
                momentFullCtx.clip();
                // 绘制壁纸，直接填满canvas
                if (wallpaper) {
                    const imageRatio = wallpaper.width / wallpaper.height;
                    const screenRatio = momentWidth / momentHeight;
                    let drawWidth, drawHeight, drawX, drawY;
                    if (imageRatio > screenRatio) {
                        drawHeight = momentHeight;
                        drawWidth = drawHeight * imageRatio;
                        drawX = -(drawWidth - momentWidth) / 2;
                        drawY = yOffset; // 应用yOffset
                    } else {
                        drawWidth = momentWidth;
                        drawHeight = drawWidth / imageRatio;
                        drawX = 0;
                        drawY = -(drawHeight - momentHeight) / 2 + yOffset; // 应用yOffset
                    }
                    momentFullCtx.drawImage(wallpaper, drawX, drawY, drawWidth, drawHeight);
                } else {
                    momentFullCtx.fillStyle = '#EEE';
                    momentFullCtx.fillRect(0, 0, momentWidth, momentHeight);
                }
                // 底部白色栏
                momentFullCtx.fillStyle = '#fff';
                momentFullCtx.fillRect(0, momentHeight - momentBarHeight, momentWidth, momentBarHeight);
                // 底部白色栏左侧说明文字
                momentFullCtx.save();
                momentFullCtx.font = 'bold 16px Inter, sans-serif';
                momentFullCtx.fillStyle = 'rgba(120,120,120,0.85)';
                momentFullCtx.textAlign = 'left';
                momentFullCtx.textBaseline = 'middle';
                momentFullCtx.shadowColor = 'rgba(255,255,255,0.7)';
                momentFullCtx.shadowBlur = 4;
                momentFullCtx.fillText('朋友圈封面预览+头像', 24, momentHeight - momentBarHeight/2);
                momentFullCtx.restore();
                // 右下角头像框
                const avatarX = momentWidth - momentAvatarSize - momentAvatarMargin;
                const avatarY = momentHeight - momentBarHeight/2 - momentAvatarSize/2;
                momentFullCtx.save();
                momentFullCtx.beginPath();
                roundRect(momentFullCtx, avatarX, avatarY, momentAvatarSize, momentAvatarSize, momentAvatarRadius);
                momentFullCtx.clip();
                if (avatarImg && avatarImg.complete) {
                    const scale = Math.max(momentAvatarSize / avatarImg.width, momentAvatarSize / avatarImg.height);
                    const ax = avatarX + (momentAvatarSize - avatarImg.width * scale) / 2;
                    const ay = avatarY + (momentAvatarSize - avatarImg.height * scale) / 2; // 移除yOffset应用，头像固定在右下角
                    momentFullCtx.drawImage(avatarImg, ax, ay, avatarImg.width * scale, avatarImg.height * scale);
                } else {
                    momentFullCtx.fillStyle = '#CCC';
                    momentFullCtx.fillRect(avatarX, avatarY, momentAvatarSize, momentAvatarSize);
                }
                momentFullCtx.restore();
                // 昵称
                momentFullCtx.font = 'bold 36px Inter, sans-serif'; // 确认字体设置
                momentFullCtx.fillStyle = '#222';
                momentFullCtx.textAlign = 'right';
                momentFullCtx.textBaseline = 'middle';
                momentFullCtx.fillText(momentName, avatarX - 20, momentHeight - momentBarHeight/2);
                // 相机icon
                momentFullCtx.save();
                // 只绘制透明PNG，不绘制背景
                if (cameraIconImg.complete && cameraIconImg.naturalWidth > 0) {
                    momentFullCtx.drawImage(cameraIconImg, momentWidth - 40 - 16, 40 - 16, 32, 32);
                } else {
                     console.warn('Camera icon image not loaded or invalid for full preview.'); // 添加警告
                     // 可以选择在这里绘制一个占位符或文字提示
                }
                momentFullCtx.restore();
                // 边框
                momentFullCtx.save();
                momentFullCtx.beginPath();
                roundRect(momentFullCtx, 0.5, 0.5, momentWidth-1, momentHeight-1, 20);
                momentFullCtx.strokeStyle = '#e5e7eb';
                momentFullCtx.lineWidth = 4;
                momentFullCtx.stroke();
                momentFullCtx.restore();
            }

            // 新增：下载原图按钮
            /**
             * 下载当前预览的原始图片
             * @description 支持首页跳转和本地上传两种情况，自动识别图片来源
             */
            const downloadOriginalButton = document.getElementById('downloadOriginalButton');
            downloadOriginalButton.addEventListener('click', function() {
                let url = '';
                // 优先使用 static/wallpapers/ 路径
                if (typeof imageUrl === 'string' && imageUrl.startsWith('static/wallpapers/')) {
                    url = imageUrl;
                } else if (currentWallpaper && typeof currentWallpaper.src === 'string' && currentWallpaper.src.startsWith('static/wallpapers/')) {
                    url = currentWallpaper.src;
                } else if (typeof imageUrl === 'string' && imageUrl.startsWith('blob:')) {
                    url = imageUrl;
                } else if (currentWallpaper && typeof currentWallpaper.src === 'string' && currentWallpaper.src.startsWith('blob:')) {
                    url = currentWallpaper.src;
                }
                if (!url) {
                    alert('未找到原图，无法下载！\n请确保是从首页跳转或本地上传原图。');
                    return;
                }
                const originalText = downloadOriginalButton.innerHTML;
                downloadOriginalButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> 下载中...';
                downloadOriginalButton.disabled = true;
                // 创建a标签下载
                const link = document.createElement('a');
                link.href = url;
                // 自动识别文件名
                let filename = url.split('/').pop().split('?')[0] || '原图.jpg';
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                // 状态恢复
                setTimeout(() => {
                    downloadOriginalButton.innerHTML = '<i class="fa-solid fa-check mr-2"></i> 下载成功';
                    downloadOriginalButton.classList.remove('bg-primary');
                    downloadOriginalButton.classList.add('bg-green-500');
                    setTimeout(() => {
                        downloadOriginalButton.innerHTML = originalText;
                        downloadOriginalButton.classList.remove('bg-green-500');
                        downloadOriginalButton.classList.add('bg-primary');
                        downloadOriginalButton.disabled = false;
                    }, 1500);
                }, 800);
            });

            // 定义图片加载和更新页面的统一函数
            /**
             * 根据图片URL加载图片，成功后更新全局currentWallpaper并绘制所有预览
             * @param {string} url - 要加载的图片的URL
             */
            function loadAndDisplayWallpaper(url) {
                const img = new Image();
                img.crossOrigin = 'anonymous'; // 解决跨域问题
                img.onload = function() {
                    currentWallpaper = img; // 成功加载后，将原图对象赋给currentWallpaper
                    previewImage.src = url; // 预览小窗口显示加载成功的URL对应的图片
                    previewControls.classList.remove('hidden'); // 显示控制区域
                    // 同步预览图片位置（仅对电脑预览有效，但这里更新小窗口预览图）
                    previewImage.style.objectPosition = `center -${yOffset}px`;
                    // 绘制所有设备canvas
                    drawPhone(currentWallpaper);
                    drawTablet(currentWallpaper);
                    drawLaptop(currentWallpaper);
                    // drawMomentPreview(currentWallpaper, currentWallpaper); // 朋友圈预览可能需要单独处理头像，暂不在这里统一绘制
                    drawMomentPreview(currentWallpaper, currentWallpaper || momentAvatarImg, yOffset); // 在加载壁纸后绘制朋友圈预览并传入yOffset

                    // 添加动画效果
                    phoneCanvas.classList.add('animate-pulse');
                    tabletCanvas.classList.add('animate-pulse');
                    laptopCanvas.classList.add('animate-pulse');
                    setTimeout(() => {
                        phoneCanvas.classList.remove('animate-pulse');
                        tabletCanvas.classList.remove('animate-pulse');
                        laptopCanvas.classList.remove('animate-pulse');
                    }, 1000);

                    console.log('壁纸加载成功：', url);
                };
                img.onerror = function() {
                    console.error('壁纸加载失败：', url);
                    alert('加载壁纸失败，请检查图片链接或重新上传！');
                    previewControls.classList.add('hidden'); // 隐藏控制区域
                    currentWallpaper = null; // 加载失败，清空currentWallpaper
                };
                img.src = url;
            }
        });
    </script>
</body>
</html>
    