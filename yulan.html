<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多设备壁纸预览</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#86909C',
                        accent: '#FF7D00',
                        dark: '#1D2129',
                        light: '#F2F3F5',
                        'apple-gray': '#8E8E93',
                        'apple-dark': '#1C1C1E',
                        'apple-white': '#F9F9F9'
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .phone-shadow {
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            }
            .button-shadow {
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }
            .canvas-container {
                perspective: 1000px;
            }
            .phone-rotate {
                transform: rotateY(5deg) rotateX(3deg);
                transform-style: preserve-3d;
            }
            .tablet-rotate {
                transform: rotateY(5deg) rotateX(2deg);
                transform-style: preserve-3d;
            }
            .laptop-rotate {
                transform: rotateX(10deg);
                transform-style: preserve-3d;
            }
            .phone-bezel {
                box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.3);
            }
            .button-hover {
                transition: all 0.3s ease;
            }
            .button-hover:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
            }
            .upload-area {
                transition: all 0.3s ease;
            }
            .upload-area:hover {
                transform: translateY(-3px);
            }
            .apple-notch {
                position: absolute;
                top: 2%;
                left: 50%;
                transform: translateX(-50%);
                width: 160px;
                height: 40px;
                background-color: #000;
                border-radius: 0 0 30px 30px;
                z-index: 2;
            }
            .device-tabs {
                @apply flex border-b;
            }
            .device-tab {
                @apply px-4 py-2 cursor-pointer font-medium transition-all duration-200;
            }
            .device-tab.active {
                @apply text-primary border-b-2 border-primary;
            }
            .device-preview {
                @apply transition-opacity duration-300;
            }
            .device-preview.hidden {
                @apply opacity-0 pointer-events-none;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-light to-gray-100 min-h-screen font-inter text-dark">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- 头部 -->
        <header class="text-center mb-12">
            <h1 class="text-[clamp(2rem,5vw,3.5rem)] font-bold text-primary mb-4 tracking-tight">
                <span class="text-accent">多设备</span>壁纸预览
            </h1>
            <p class="text-gray-600 text-[clamp(1rem,2vw,1.25rem)] max-w-2xl mx-auto">
                上传你的壁纸，在手机、平板和电脑上预览效果，下载适配不同设备的壁纸
            </p>
        </header>

        <div class="flex flex-col lg:flex-row gap-12 items-center justify-center">
            <!-- 设备预览区域 -->
            <div class="w-full lg:w-1/2">
                <!-- 设备选择标签 -->
                <div class="device-tabs mb-6">
                    <div class="device-tab active" data-device="phone">
                        <i class="fa-solid fa-mobile-screen-button mr-2"></i>手机
                    </div>
                    <div class="device-tab" data-device="tablet">
                        <i class="fa-solid fa-tablet-screen-button mr-2"></i>平板
                    </div>
                    <div class="device-tab" data-device="laptop">
                        <i class="fa-solid fa-laptop mr-2"></i>电脑
                    </div>
                    <div class="device-tab" data-device="moment">
                        <i class="fa-solid fa-image mr-2"></i>朋友圈
                    </div>
                </div>

                <!-- 设备预览容器 -->
                <div class="relative">
                    <!-- 手机预览 -->
                    <div class="device-preview" id="phonePreview">
                        <div class="relative phone-rotate">
                            <canvas id="phoneCanvas" class="mx-auto phone-shadow rounded-[40px] phone-bezel"></canvas>
                            <!-- 苹果手机刘海 -->
                            <div class="apple-notch"></div>
                        </div>
                    </div>

                    <!-- 平板预览 -->
                    <div class="device-preview hidden" id="tabletPreview">
                        <div class="relative tablet-rotate">
                            <canvas id="tabletCanvas" class="mx-auto phone-shadow rounded-[25px] phone-bezel"></canvas>
                        </div>
                    </div>

                    <!-- 电脑预览 -->
                    <div class="device-preview hidden" id="laptopPreview">
                        <div class="relative laptop-rotate">
                            <canvas id="laptopCanvas" class="mx-auto"></canvas>
                        </div>
                    </div>

                    <!-- 朋友圈预览 -->
                    <div class="device-preview hidden" id="momentPreview">
                        <div class="relative flex justify-center">
                            <canvas id="momentCanvas" class="mx-auto rounded-2xl shadow-lg" style="max-width:720px;width:100%;height:auto;display:block;"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 功能区域 -->
            <div class="w-full lg:w-1/2 flex flex-col items-center">
                <!-- 上传区域 -->
                <div id="uploadArea" class="upload-area w-full max-w-md bg-white rounded-2xl p-8 shadow-lg mb-8 border-2 border-dashed border-gray-300 hover:border-primary transition-all duration-300">
                    <label for="wallpaperUpload" class="cursor-pointer flex flex-col items-center justify-center">
                        <div class="text-center mb-4">
                            <i class="fa-solid fa-cloud-arrow-up text-4xl text-primary mb-3"></i>
                            <h3 class="text-xl font-semibold mb-2">上传壁纸</h3>
                            <p class="text-gray-500 text-sm">点击或拖拽图片到此处 (支持 JPG, PNG, WebP)</p>
                        </div>
                        <input type="file" id="wallpaperUpload" accept="image/*" class="hidden" />
                        <button id="uploadButton" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-3 px-6 rounded-lg transition-all duration-300 button-hover button-shadow flex items-center justify-center">
                            <i class="fa-solid fa-image mr-2"></i> 选择壁纸
                        </button>
                    </label>
                </div>

                <!-- 预览控制区域 -->
                <div id="previewControls" class="w-full max-w-md bg-white rounded-2xl p-6 shadow-lg mb-8 hidden">
                    <h3 class="text-xl font-semibold mb-4">壁纸预览</h3>
                    
                    <!-- 壁纸预览小窗口 -->
                    <div class="relative w-full aspect-[146/76] bg-gray-100 rounded-xl mb-6 overflow-hidden flex items-center justify-center" style="min-height:220px;">
                        <img id="previewImage" src="" alt="壁纸预览" class="max-w-full max-h-80 object-contain rounded-xl shadow transition-all duration-300" style="aspect-ratio:146/76; background:#eee;">
                    </div>
                    
                    <!-- 控制按钮 -->
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="downloadPhoneButton" class="flex-1 bg-accent hover:bg-accent/90 text-white font-medium py-3 px-6 rounded-lg transition-all duration-300 button-hover button-shadow flex items-center justify-center">
                            <i class="fa-solid fa-mobile-screen-button mr-2"></i> 手机
                        </button>
                        <button id="downloadTabletButton" class="flex-1 bg-secondary hover:bg-secondary/90 text-white font-medium py-3 px-6 rounded-lg transition-all duration-300 button-hover button-shadow flex items-center justify-center">
                            <i class="fa-solid fa-tablet-screen-button mr-2"></i> 平板
                        </button>
                        <button id="downloadLaptopButton" class="flex-1 bg-primary hover:bg-primary/90 text-white font-medium py-3 px-6 rounded-lg transition-all duration-300 button-hover button-shadow flex items-center justify-center">
                            <i class="fa-solid fa-laptop mr-2"></i> 电脑
                        </button>
                    </div>
                    

                    
                    <!-- 微信头像和封面下载按钮 -->
                    <div class="mt-4 flex flex-col sm:flex-row gap-4">
                        <button id="downloadAvatarButton" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-medium py-3 px-6 rounded-lg transition-all duration-300 button-hover button-shadow flex items-center justify-center">
                            <i class="fa-solid fa-user-circle mr-2"></i> 头像
                        </button>
                        <button id="downloadCoverButton" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-6 rounded-lg transition-all duration-300 button-hover button-shadow flex items-center justify-center">
                            <i class="fa-solid fa-image mr-2"></i> 封面
                        </button>
                        <button id="downloadBothButton" class="flex-1 bg-purple-500 hover:bg-purple-600 text-white font-medium py-3 px-6 rounded-lg transition-all duration-300 button-hover button-shadow flex items-center justify-center">
                            <i class="fa-solid fa-download mr-2"></i> 组合
                        </button>
                    </div>

                    <!-- 一键下载高清壁纸按钮 -->
                    <div class="mt-4 flex flex-col sm:flex-row gap-4">
                        <button id="downloadHDAllButton" class="w-full bg-gradient-to-r from-blue-500 to-green-400 hover:from-blue-600 hover:to-green-500 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 button-hover button-shadow flex items-center justify-center">
                            <i class="fa-solid fa-cloud-arrow-down mr-2"></i> 一键下载高清壁纸（手机/平板/电脑）
                        </button>
                    </div>

                     <!-- 调试控制区域 -->
                     <div class="mt-6 pt-4 border-t border-gray-200">
                        <h4 class="font-semibold text-sm mb-2 flex items-center">
                            <i class="fa-solid fa-sliders text-secondary mr-2"></i> 壁纸位置调整（仅对电脑壁纸有效）
                        </h4>
                        <div class="flex items-center gap-2">
                            <button id="moveUpBtn" class="px-3 py-1 bg-gray-200 rounded-lg text-sm hover:bg-gray-300">
                                <i class="fa-solid fa-arrow-up"></i> 上移
                            </button>
                            <button id="moveDownBtn" class="px-3 py-1 bg-gray-200 rounded-lg text-sm hover:bg-gray-300">
                                <i class="fa-solid fa-arrow-down"></i> 下移
                            </button>
                            <span id="offsetValue" class="text-xs text-gray-500">偏移: 0px</span>
                        </div>
                    </div>                   

                </div>

                <!-- 信息卡片 -->
                <div class="w-full max-w-md bg-white rounded-2xl p-6 shadow-lg">
                    <h3 class="text-xl font-semibold mb-3 flex items-center">
                        <i class="fa-solid fa-info-circle text-primary mr-2"></i> 使用说明
                    </h3>
                    <ul class="space-y-2 text-gray-600">
                        <li class="flex items-start">
                            <i class="fa-solid fa-check-circle text-primary mt-1 mr-2"></i>
                            <span>点击"选择壁纸"按钮上传本地图片</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fa-solid fa-check-circle text-primary mt-1 mr-2"></i>
                            <span>上传后可在左侧预览不同设备的效果</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fa-solid fa-check-circle text-primary mt-1 mr-2"></i>
                            <span>点击对应按钮下载适配不同设备的壁纸</span>
                        </li>
                        <li class="flex items-start">
                            <i class="fa-solid fa-check-circle text-primary mt-1 mr-2"></i>
                            <span>支持 JPG、PNG 和 WebP 格式图片</span>
                        </li>
                    </ul>
                    

                </div>
            </div>
        </div>

        <!-- 页脚 -->
        <footer class="mt-16 text-center text-gray-500 text-sm">
            <p>© 2025 多设备壁纸预览工具 | 仅供演示使用</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (window.location.hash === '#previewControls') {
                const target = document.getElementById('previewControls');
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
            // 获取DOM元素
            const phoneCanvas = document.getElementById('phoneCanvas');
            const tabletCanvas = document.getElementById('tabletCanvas');
            const laptopCanvas = document.getElementById('laptopCanvas');
            
            const phoneCtx = phoneCanvas.getContext('2d');
            const tabletCtx = tabletCanvas.getContext('2d');
            const laptopCtx = laptopCanvas.getContext('2d');
            
            const wallpaperUpload = document.getElementById('wallpaperUpload');
            const uploadButton = document.getElementById('uploadButton');
            const uploadArea = document.getElementById('uploadArea');
            const previewControls = document.getElementById('previewControls');
            const previewImage = document.getElementById('previewImage');
            
            const downloadPhoneButton = document.getElementById('downloadPhoneButton');
            const downloadTabletButton = document.getElementById('downloadTabletButton');
            const downloadLaptopButton = document.getElementById('downloadLaptopButton');
            
            // 新增微信相关按钮
            const downloadAvatarButton = document.getElementById('downloadAvatarButton');
            const downloadCoverButton = document.getElementById('downloadCoverButton');
            const downloadBothButton = document.getElementById('downloadBothButton');
            
            // 微信头像和封面尺寸定义
            const avatarSize = {
                width: 300,
                height: 300,
                radius: 150,
                roundRadius: 20  // 圆角方形头像的圆角半径
            };
            
            const coverSize = {
                width: 750,
                height: 422
            };
            
            const deviceTabs = document.querySelectorAll('.device-tab');
            const devicePreviews = document.querySelectorAll('.device-preview');
            
            // 调试控制元素
            const moveUpBtn = document.getElementById('moveUpBtn');
            const moveDownBtn = document.getElementById('moveDownBtn');
            const offsetValue = document.getElementById('offsetValue');
            
            // 设备尺寸比例
            const phoneWidth = 300;
            const phoneHeight = 620;
            const phoneBezelWidth = 8; // 手机边框宽度
            const phoneCornerRadius = 40; // 手机圆角半径
            
            const tabletWidth = 420;
            const tabletHeight = 560;
            const tabletBezelWidth = 12; // 平板边框宽度
            const tabletCornerRadius = 25; // 平板圆角半径
            
            const laptopWidth = 600;
            const laptopHeight = 360;
            const laptopScreenHeight = 320;
            const laptopBezelWidth = 8; // 电脑边框宽度
            const laptopBaseHeight = 40; // 电脑底座高度
            
            // 朋友圈封面尺寸
            const momentWidth = 750;
            const momentHeight = 422;
            const momentBarHeight = 100; // 底部白色栏高度
            const momentAvatarSize = 80;
            const momentAvatarRadius = 20;
            const momentAvatarMargin = 24;
            const momentName = 'Jelis';
            let momentAvatarImg = null;
            
            // 壁纸位置偏移量
            let yOffset = 0;
            
            // 设置Canvas尺寸
            phoneCanvas.width = phoneWidth;
            phoneCanvas.height = phoneHeight;
            
            tabletCanvas.width = tabletWidth;
            tabletCanvas.height = tabletHeight;
            
            laptopCanvas.width = laptopWidth;
            laptopCanvas.height = laptopHeight + laptopBaseHeight;
            
            // 朋友圈canvas尺寸
            const momentCanvas = document.getElementById('momentCanvas');
            momentCanvas.width = momentWidth;
            momentCanvas.height = momentHeight;
            const momentCtx = momentCanvas.getContext('2d');
            
            // 加载本地相机icon
            const cameraIconImg = new Image();
            cameraIconImg.src = '相机.png'; // 请确保与index.html同目录
            
            // 获取URL参数中的图片
            const urlParams = new URLSearchParams(window.location.search);
            let imageUrl = urlParams.get('image');
            // 自动将缩略图路径替换为原图路径（如有需要，可自定义规则）
            if (imageUrl) {
                // 例如如果有thumb/或small/等目录，可替换为原图目录
                imageUrl = imageUrl.replace('/thumb/', '/').replace('/small/', '/');
            }
            if (imageUrl) {
                // 如果有图片URL，加载该图片
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = function() {
                    currentWallpaper = img;
                    previewImage.src = imageUrl;
                    previewControls.classList.remove('hidden');
                    // 加载高清原图后，重绘所有设备canvas
                    drawPhone(currentWallpaper);
                    drawTablet(currentWallpaper);
                    drawLaptop(currentWallpaper);
                    drawMomentPreview(currentWallpaper, currentWallpaper);
                };
                img.src = imageUrl;
            } else {
                // 如果没有图片URL，加载默认图片
                const defaultWallpaper = new Image();
                defaultWallpaper.src = 'Jelis.jpeg';
                defaultWallpaper.onload = function() {
                    currentWallpaper = defaultWallpaper;
                    previewImage.src = defaultWallpaper.src;
                    previewControls.classList.remove('hidden');
                    drawPhone(defaultWallpaper);
                    drawTablet(defaultWallpaper);
                    drawLaptop(defaultWallpaper);
                };
            }
            
            // 设备切换
            deviceTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // 移除所有活动状态
                    deviceTabs.forEach(t => t.classList.remove('active'));
                    devicePreviews.forEach(p => p.classList.add('hidden'));
                    
                    // 添加当前活动状态
                    tab.classList.add('active');
                    const device = tab.getAttribute('data-device');
                    document.getElementById(`${device}Preview`).classList.remove('hidden');
                    
                    // 切换到朋友圈时重绘
                    if(device === 'moment') {
                        drawMomentPreview(currentWallpaper, currentWallpaper || momentAvatarImg);
                    } else if (device === 'phone') {
                        drawPhone(currentWallpaper);
                    } else if (device === 'tablet') {
                        drawTablet(currentWallpaper);
                    } else if (device === 'laptop') {
                        drawLaptop(currentWallpaper);
                    }
                });
            });
            
            // 上传按钮点击事件
            uploadButton.addEventListener('click', () => {
                wallpaperUpload.click();
            });
            
            // 文件上传事件
            wallpaperUpload.addEventListener('change', handleFileUpload);
            
            // 拖拽上传
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('border-primary');
                uploadArea.classList.add('bg-gray-50');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('border-primary');
                uploadArea.classList.remove('bg-gray-50');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('border-primary');
                uploadArea.classList.remove('bg-gray-50');
                
                if (e.dataTransfer.files.length) {
                    wallpaperUpload.files = e.dataTransfer.files;
                    handleFileUpload();
                }
            });
            
            // 下载按钮点击事件
            downloadPhoneButton.addEventListener('click', () => downloadPreview(phoneCanvas, '手机', 'phone'));
            downloadTabletButton.addEventListener('click', () => downloadPreview(tabletCanvas, '平板', 'tablet'));
            downloadLaptopButton.addEventListener('click', () => downloadPreview(laptopCanvas, '电脑', 'laptop'));
            
            // 新增微信相关下载事件
            downloadAvatarButton.addEventListener('click', downloadAvatar);
            downloadCoverButton.addEventListener('click', downloadCover);
            downloadBothButton.addEventListener('click', downloadBoth);
            
            // 一键下载高清壁纸按钮
            const downloadHDAllButton = document.getElementById('downloadHDAllButton');
            downloadHDAllButton.addEventListener('click', function() {
                if (!currentWallpaper || !currentWallpaper.complete || !currentWallpaper.naturalWidth === 0) {
                    alert('壁纸未加载完成，无法下载！');
                    return;
                }
                downloadHDAllButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> 下载中...';
                downloadHDAllButton.disabled = true;
                // 手机
                exportHDWallpaper(currentWallpaper, 1080, 2400, '手机高清壁纸.jpg');
                // 平板
                exportHDWallpaper(currentWallpaper, 1600, 2560, '平板高清壁纸.jpg');
                // 电脑，内容区yOffset等比例缩放并加补偿
                const previewContentHeight = 320 - 3 * 8; // 296
                const exportContentHeight = 1600;
                const compensation = 400; // 导出时上调60像素
                const scaledYOffset = yOffset * (exportContentHeight / previewContentHeight) - compensation;
                exportHDWallpaper(currentWallpaper, 2560, 1600, '电脑高清壁纸.jpg', scaledYOffset);
                setTimeout(() => {
                    downloadHDAllButton.innerHTML = '<i class="fa-solid fa-cloud-arrow-down mr-2"></i> 一键下载高清壁纸（手机/平板/电脑）';
                    downloadHDAllButton.disabled = false;
                }, 2000);
            });

            /**
             * 导出高清壁纸（等比例居中裁剪，电脑壁纸支持yOffset）
             * @param {HTMLImageElement} img - 原始壁纸图片
             * @param {number} targetWidth - 导出宽度
             * @param {number} targetHeight - 导出高度
             * @param {string} filename - 文件名
             * @param {number} yOffset - 仅电脑壁纸用，壁纸上下偏移
             */
            function exportHDWallpaper(img, targetWidth, targetHeight, filename, yOffset = 0) {
                const canvas = document.createElement('canvas');
                canvas.width = targetWidth;
                canvas.height = targetHeight;
                const ctx = canvas.getContext('2d');
                // 电脑壁纸导出时，内容区绘制逻辑与预览一致，防止顶部黑边
                if (targetWidth === 2560 && targetHeight === 1600) {
                    const imageRatio = img.width / img.height;
                    const screenRatio = targetWidth / targetHeight;
                    let drawWidth, drawHeight, drawX, drawY;
                    if (imageRatio > screenRatio) {
                        drawHeight = targetHeight;
                        drawWidth = drawHeight * imageRatio;
                        drawX = -(drawWidth - targetWidth) / 2;
                        drawY = - (drawHeight - targetHeight) / 2 + yOffset;
                    } else {
                        drawWidth = targetWidth;
                        drawHeight = drawWidth / imageRatio;
                        drawX = 0;
                        drawY = - (drawHeight - targetHeight) / 2 + yOffset;
                    }
                    ctx.drawImage(img, drawX, drawY, drawWidth, drawHeight);
                } else {
                    // 其它设备保持原有逻辑
                    const imgRatio = img.width / img.height;
                    const targetRatio = targetWidth / targetHeight;
                    let drawWidth, drawHeight, drawX, drawY;
                    if (imgRatio > targetRatio) {
                        drawHeight = targetHeight;
                        drawWidth = drawHeight * imgRatio;
                        drawX = -(drawWidth - targetWidth) / 2;
                        drawY = 0;
                    } else {
                        drawWidth = targetWidth;
                        drawHeight = drawWidth / imgRatio;
                        drawX = 0;
                        drawY = -(drawHeight - targetHeight) / 2;
                    }
                    ctx.drawImage(img, drawX, drawY, drawWidth, drawHeight);
                }
                // 导出JPG格式，质量0.92
                const dataURL = canvas.toDataURL('image/jpeg', 0.92);
                const link = document.createElement('a');
                link.download = filename;
                link.href = dataURL;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            // 处理文件上传
            function handleFileUpload() {
                const file = wallpaperUpload.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.crossOrigin = 'anonymous'; // 防止canvas污染
                    img.onload = function() {
                        currentWallpaper = img;
                        previewImage.src = e.target.result;
                        previewControls.classList.remove('hidden');
                        // 同步预览图片位置
                        previewImage.style.objectPosition = `center -${yOffset}px`;
                        drawPhone(img);
                        drawTablet(img);
                        drawLaptop(img);
                        drawMomentPreview(img, img);
                        phoneCanvas.classList.add('animate-pulse');
                        tabletCanvas.classList.add('animate-pulse');
                        laptopCanvas.classList.add('animate-pulse');
                        setTimeout(() => {
                            phoneCanvas.classList.remove('animate-pulse');
                            tabletCanvas.classList.remove('animate-pulse');
                            laptopCanvas.classList.remove('animate-pulse');
                        }, 1000);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
            
            // 绘制手机
            function drawPhone(wallpaper) {
                // 清除画布
                phoneCtx.clearRect(0, 0, phoneWidth, phoneHeight);
                
                // 绘制手机外壳（边框）
                phoneCtx.fillStyle = '#1C1C1E'; // 深空灰色
                roundRect(phoneCtx, 0, 0, phoneWidth, phoneHeight, phoneCornerRadius);
                phoneCtx.fill();
                
                // 绘制手机正面屏幕区域
                phoneCtx.fillStyle = '#000';
                roundRect(phoneCtx, phoneBezelWidth, phoneBezelWidth, phoneWidth - 2 * phoneBezelWidth, phoneHeight - 2 * phoneBezelWidth, phoneCornerRadius - 8);
                phoneCtx.fill();
                
                // 绘制屏幕内容（如果有壁纸则显示壁纸）
                if (wallpaper) {
                    // 计算壁纸缩放比例以适应屏幕并应用圆角
                    drawRoundedImage(phoneCtx, wallpaper, phoneBezelWidth * 1.5, phoneBezelWidth * 1.5, 
                                    phoneWidth - 3 * phoneBezelWidth, phoneHeight - 3 * phoneBezelWidth, 
                                    phoneCornerRadius - 10);
                } else {
                    // 没有壁纸时显示默认背景
                    phoneCtx.fillStyle = '#F9F9F9';
                    roundRect(phoneCtx, phoneBezelWidth * 1.5, phoneBezelWidth * 1.5, phoneWidth - 3 * phoneBezelWidth, phoneHeight - 3 * phoneBezelWidth, phoneCornerRadius - 10);
                    phoneCtx.fill();
                }
            }
            
            // 绘制平板
            function drawTablet(wallpaper) {
                // 清除画布
                tabletCtx.clearRect(0, 0, tabletWidth, tabletHeight);
                
                // 绘制平板外壳（边框）
                tabletCtx.fillStyle = '#1C1C1E'; // 深空灰色
                roundRect(tabletCtx, 0, 0, tabletWidth, tabletHeight, tabletCornerRadius);
                tabletCtx.fill();
                
                // 绘制平板正面屏幕区域
                tabletCtx.fillStyle = '#000';
                roundRect(tabletCtx, tabletBezelWidth, tabletBezelWidth, tabletWidth - 2 * tabletBezelWidth, tabletHeight - 2 * tabletBezelWidth, tabletCornerRadius - 5);
                tabletCtx.fill();
                
                // 绘制屏幕内容（如果有壁纸则显示壁纸）
                if (wallpaper) {
                    // 计算壁纸缩放比例以适应屏幕并应用圆角
                    drawRoundedImage(tabletCtx, wallpaper, tabletBezelWidth * 1.5, tabletBezelWidth * 1.5, 
                                    tabletWidth - 3 * tabletBezelWidth, tabletHeight - 3 * tabletBezelWidth, 
                                    tabletCornerRadius - 8);
                } else {
                    // 没有壁纸时显示默认背景
                    tabletCtx.fillStyle = '#F9F9F9';
                    roundRect(tabletCtx, tabletBezelWidth * 1.5, tabletBezelWidth * 1.5, tabletWidth - 3 * tabletBezelWidth, tabletHeight - 3 * tabletBezelWidth, tabletCornerRadius - 8);
                    tabletCtx.fill();
                }
            }
            
            // 绘制电脑
            function drawLaptop(wallpaper) {
                // 清除画布
                laptopCtx.clearRect(0, 0, laptopWidth, laptopHeight + laptopBaseHeight);
                
                // 绘制电脑屏幕边框
                laptopCtx.fillStyle = '#1C1C1E'; // 深空灰色
                roundRect(laptopCtx, 0, 0, laptopWidth, laptopHeight, 10);
                laptopCtx.fill();
                
                // 绘制电脑屏幕区域
                laptopCtx.fillStyle = '#000';
                roundRect(laptopCtx, laptopBezelWidth, laptopBezelWidth, laptopWidth - 2 * laptopBezelWidth, laptopScreenHeight - 2 * laptopBezelWidth, 5);
                laptopCtx.fill();
                
                // 绘制屏幕内容（如果有壁纸则显示壁纸）
                if (wallpaper) {
                    const screenWidth = laptopWidth - 3 * laptopBezelWidth;
                    const screenHeight = laptopScreenHeight - 3 * laptopBezelWidth;
                    const screenX = laptopBezelWidth * 1.5;
                    const screenY = laptopBezelWidth * 1.5;
                    drawWallpaperContentArea(laptopCtx, wallpaper, screenX, screenY, screenWidth, screenHeight, yOffset);
                } else {
                    // 没有壁纸时显示默认背景
                    laptopCtx.fillStyle = '#F9F9F9';
                    roundRect(laptopCtx, laptopBezelWidth * 1.5, laptopBezelWidth * 1.5, laptopWidth - 3 * laptopBezelWidth, laptopScreenHeight - 3 * laptopBezelWidth, 5);
                    laptopCtx.fill();
                }
                
                // 绘制电脑底座
                laptopCtx.fillStyle = '#2A2A2A';
                laptopCtx.fillRect(0, laptopHeight, laptopWidth, laptopBaseHeight);
                
                // 绘制底座凹槽
                laptopCtx.fillStyle = '#1A1A1A';
                laptopCtx.beginPath();
                laptopCtx.moveTo(laptopWidth * 0.2, laptopHeight);
                laptopCtx.bezierCurveTo(laptopWidth * 0.5, laptopHeight - 8, laptopWidth * 0.8, laptopHeight, laptopWidth * 0.8, laptopHeight);
                laptopCtx.lineTo(laptopWidth * 0.2, laptopHeight);
                laptopCtx.closePath();
                laptopCtx.fill();
            }
            
            // 绘制带圆角的图像
            function drawRoundedImage(ctx, img, x, y, width, height, radius) {
                ctx.save();
                ctx.beginPath();
                ctx.moveTo(x + radius, y);
                ctx.lineTo(x + width - radius, y);
                ctx.arcTo(x + width, y, x + width, y + radius, radius);
                ctx.lineTo(x + width, y + height - radius);
                ctx.arcTo(x + width, y + height, x + width - radius, y + height, radius);
                ctx.lineTo(x + radius, y + height);
                ctx.arcTo(x, y + height, x, y + height - radius, radius);
                ctx.lineTo(x, y + radius);
                ctx.arcTo(x, y, x + radius, y, radius);
                ctx.closePath();
                ctx.clip();
                
                // 计算壁纸缩放比例以适应屏幕
                const imageRatio = img.width / img.height;
                const screenRatio = width / height;
                
                let drawWidth, drawHeight, drawX, drawY;
                
                if (imageRatio > screenRatio) {
                    // 图片比屏幕宽，等比例缩放高度
                    drawHeight = height;
                    drawWidth = drawHeight * imageRatio;
                    drawX = x - (drawWidth - width) / 2;
                    drawY = y;
                } else {
                    // 图片比屏幕高，等比例缩放宽度
                    drawWidth = width;
                    drawHeight = drawWidth / imageRatio;
                    // 居中显示图片
                    drawX = x;
                    drawY = y - (drawHeight - height) / 2;
                }
                
                ctx.drawImage(img, drawX, drawY, drawWidth, drawHeight);
                ctx.restore();
            }
            
            // 绘制圆角矩形
            function roundRect(ctx, x, y, width, height, radius) {
                ctx.beginPath();
                ctx.moveTo(x + radius, y);
                ctx.lineTo(x + width - radius, y);
                ctx.arcTo(x + width, y, x + width, y + radius, radius);
                ctx.lineTo(x + width, y + height - radius);
                ctx.arcTo(x + width, y + height, x + width - radius, y + height, radius);
                ctx.lineTo(x + radius, y + height);
                ctx.arcTo(x, y + height, x, y + height - radius, radius);
                ctx.lineTo(x, y + radius);
                ctx.arcTo(x, y, x + radius, y, radius);
                ctx.closePath();
            }
            
            // 绘制手机状态栏
            function drawPhoneStatusBar() {
                phoneCtx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                phoneCtx.fillRect(phoneBezelWidth * 1.5, phoneBezelWidth * 1.5, phoneWidth - 3 * phoneBezelWidth, 30);
                
                // 绘制时间
                phoneCtx.fillStyle = '#FFF';
                phoneCtx.font = 'bold 14px Inter';
                phoneCtx.textAlign = 'center';
                phoneCtx.fillText('9:41', phoneWidth / 2, phoneBezelWidth * 1.5 + 20);
                
                // 绘制信号、电池等图标（简化版）
                phoneCtx.fillStyle = '#FFF';
                phoneCtx.font = '12px Font Awesome 6 Free';
                phoneCtx.textAlign = 'right';
                phoneCtx.fillText('\uf1eb \uf2f1 \uf240', phoneWidth - phoneBezelWidth * 2, phoneBezelWidth * 1.5 + 20);
            }
            
            // 绘制手机底部指示条
            function drawPhoneHomeIndicator() {
                phoneCtx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                phoneCtx.beginPath();
                phoneCtx.roundRect(phoneWidth / 2 - 60, phoneHeight - phoneBezelWidth * 3, 120, 5, 2.5);
                phoneCtx.fill();
            }
            
            // 绘制平板状态栏
            function drawTabletStatusBar() {
                tabletCtx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                tabletCtx.fillRect(tabletBezelWidth * 1.5, tabletBezelWidth * 1.5, tabletWidth - 3 * tabletBezelWidth, 40);
                
                // 绘制时间
                tabletCtx.fillStyle = '#FFF';
                tabletCtx.font = 'bold 16px Inter';
                tabletCtx.textAlign = 'center';
                tabletCtx.fillText('9:41', tabletWidth / 2, tabletBezelWidth * 1.5 + 25);
                
                // 绘制信号、电池等图标（简化版）
                tabletCtx.fillStyle = '#FFF';
                tabletCtx.font = '14px Font Awesome 6 Free';
                tabletCtx.textAlign = 'right';
                tabletCtx.fillText('\uf1eb \uf2f1 \uf240', tabletWidth - tabletBezelWidth * 2, tabletBezelWidth * 1.5 + 25);
            }
            
            // 绘制电脑任务栏
            function drawLaptopTaskbar() {
                const taskbarHeight = 40;
                laptopCtx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                laptopCtx.fillRect(laptopBezelWidth * 1.5, laptopScreenHeight - taskbarHeight - laptopBezelWidth * 1.5, 
                                  laptopWidth - 3 * laptopBezelWidth, taskbarHeight);
                
                // 绘制开始按钮
                laptopCtx.fillStyle = '#165DFF';
                laptopCtx.beginPath();
                laptopCtx.arc(laptopBezelWidth * 3, laptopScreenHeight - taskbarHeight/2 - laptopBezelWidth * 1.5, 15, 0, Math.PI * 2);
                laptopCtx.fill();
                
                // 绘制开始按钮图标
                laptopCtx.fillStyle = '#FFF';
                laptopCtx.font = '20px Font Awesome 6 Free';
                laptopCtx.textAlign = 'center';
                laptopCtx.fillText('\uf11b', laptopBezelWidth * 3, laptopScreenHeight - taskbarHeight/2 - laptopBezelWidth * 1.5 + 7);
                
                // 绘制任务栏图标
                const taskbarIcons = [
                    '\uf1c9', '\uf0c3', '\uf0e0', '\uf17a'
                ];
                
                taskbarIcons.forEach((icon, index) => {
                    laptopCtx.fillStyle = '#FFF';
                    laptopCtx.font = '20px Font Awesome 6 Free';
                    laptopCtx.textAlign = 'center';
                    laptopCtx.fillText(icon, laptopBezelWidth * 6 + index * 50, laptopScreenHeight - taskbarHeight/2 - laptopBezelWidth * 1.5 + 7);
                });
                
                // 绘制系统托盘
                laptopCtx.fillStyle = '#FFF';
                laptopCtx.font = '14px Font Awesome 6 Free';
                laptopCtx.textAlign = 'right';
                laptopCtx.fillText('\uf028 \uf1eb \uf240 9:41', laptopWidth - laptopBezelWidth * 3, laptopScreenHeight - taskbarHeight/2 - laptopBezelWidth * 1.5 + 5);
            }
            
            // 绘制内容区壁纸（预览和导出都用这个）
            function drawWallpaperContentArea(ctx, img, x, y, w, h, yOffset = 0) {
                const imageRatio = img.width / img.height;
                const screenRatio = w / h;
                let drawWidth, drawHeight, drawX, drawY;
                if (imageRatio > screenRatio) {
                    drawHeight = h;
                    drawWidth = drawHeight * imageRatio;
                    drawX = x - (drawWidth - w) / 2;
                    drawY = y + yOffset;
                } else {
                    drawWidth = w;
                    drawHeight = drawWidth / imageRatio;
                    drawX = x;
                    drawY = y - (drawHeight - h) / 2 + yOffset;
                }
                ctx.drawImage(img, drawX, drawY, drawWidth, drawHeight);
            }
            
            // 下载预览图
            function downloadPreview(canvas, filename, deviceType) {
                // 检查壁纸是否加载完成
                if (!currentWallpaper || !currentWallpaper.complete || currentWallpaper.naturalWidth === 0) {
                    alert('壁纸未加载完成，无法下载！');
                    return;
                }
                let button;
                switch(filename) {
                    case '手机':
                        button = downloadPhoneButton;
                        break;
                    case '平板':
                        button = downloadTabletButton;
                        break;
                    case '电脑':
                        button = downloadLaptopButton;
                        break;
                    default:
                        return;
                }
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> 下载中...';
                button.disabled = true;
                try {
                    // 1. 下载"外观+壁纸"
                    if (canvas === phoneCanvas) drawPhone(currentWallpaper);
                    if (canvas === tabletCanvas) drawTablet(currentWallpaper);
                    if (canvas === laptopCanvas) drawLaptop(currentWallpaper);
                    let dataURL = '';
                    try {
                        dataURL = canvas.toDataURL('image/png');
                    } catch (err) {
                        alert('下载失败：图片跨域或canvas被污染，无法导出。请确保上传的是本地图片或同源图片。\n详细信息：' + err.message);
                        button.innerHTML = '<i class="fa-solid fa-times mr-2"></i> 下载失败';
                        button.classList.remove('bg-accent', 'bg-secondary', 'bg-primary');
                        button.classList.add('bg-red-500');
                        setTimeout(() => {
                            button.innerHTML = originalText;
                            button.classList.remove('bg-red-500');
                            if (filename === '手机') {
                                button.classList.add('bg-accent');
                            } else if (filename === '平板') {
                                button.classList.add('bg-secondary');
                            } else {
                                button.classList.add('bg-primary');
                            }
                            button.disabled = false;
                        }, 2000);
                        return;
                    }
                    exportCanvasAsImage(canvas, filename + '.png');

                    // 2. 下载"仅壁纸"
                    let pureCanvas = document.createElement('canvas');
                    let pureCtx = pureCanvas.getContext('2d');
                    if (deviceType === 'phone') {
                        // 手机屏幕区域
                        const w = 300 - 3 * 8;
                        const h = 620 - 3 * 8;
                        pureCanvas.width = w;
                        pureCanvas.height = h;
                        drawWallpaperContentArea(pureCtx, currentWallpaper, 0, 0, w, h, yOffset);
                    } else if (deviceType === 'tablet') {
                        const w = 420 - 3 * 12;
                        const h = 560 - 3 * 12;
                        pureCanvas.width = w;
                        pureCanvas.height = h;
                        drawWallpaperContentArea(pureCtx, currentWallpaper, 0, 0, w, h, yOffset);
                    } else if (deviceType === 'laptop') {
                        const w = 600 - 3 * 8; // 576
                        const h = 320 - 3 * 8; // 296
                        pureCanvas.width = w;
                        pureCanvas.height = h;
                        // 电脑壁纸内容区与预览完全一致
                        drawWallpaperContentArea(pureCtx, currentWallpaper, 0, 0, w, h, yOffset);
                    }
                    // 中文命名
                    let pureName = '';
                    if (deviceType === 'phone') pureName = '手机纯壁纸.png';
                    if (deviceType === 'tablet') pureName = '平板纯壁纸.png';
                    if (deviceType === 'laptop') pureName = '电脑纯壁纸.png';
                    exportCanvasAsImage(pureCanvas, pureName);

                    // 更新按钮状态
                    button.innerHTML = '<i class="fa-solid fa-check mr-2"></i> 下载成功';
                    button.classList.remove('bg-accent', 'bg-secondary', 'bg-primary');
                    button.classList.add('bg-green-500');
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.classList.remove('bg-green-500');
                        if (filename === '手机') {
                            button.classList.add('bg-accent');
                        } else if (filename === '平板') {
                            button.classList.add('bg-secondary');
                        } else {
                            button.classList.add('bg-primary');
                        }
                        button.disabled = false;
                    }, 2000);
                } catch (error) {
                    console.error('下载失败:', error);
                    button.innerHTML = '<i class="fa-solid fa-times mr-2"></i> 下载失败';
                    button.classList.remove('bg-accent', 'bg-secondary', 'bg-primary');
                    button.classList.add('bg-red-500');
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.classList.remove('bg-red-500');
                        if (filename === '手机') {
                            button.classList.add('bg-accent');
                        } else if (filename === '平板') {
                            button.classList.add('bg-secondary');
                        } else {
                            button.classList.add('bg-primary');
                        }
                        button.disabled = false;
                    }, 2000);
                }
            }

            // 导出canvas为图片
            function exportCanvasAsImage(canvas, filename) {
                let dataURL = canvas.toDataURL('image/png');
                let link = document.createElement('a');
                link.download = filename;
                link.href = dataURL;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // 添加壁纸位置调整功能
            moveUpBtn.addEventListener('click', function() {
                if (yOffset > 0) {
                    yOffset -= 10;
                    updateOffsetDisplay();
                    if (currentWallpaper) {
                        // 更新电脑壁纸位置
                        drawLaptop(currentWallpaper);
                        // 更新预览图位置
                        previewImage.style.objectPosition = `center -${yOffset}px`;
                    }
                }
            });
            
            moveDownBtn.addEventListener('click', function() {
                yOffset += 10;
                updateOffsetDisplay();
                if (currentWallpaper) {
                    // 更新电脑壁纸位置
                    drawLaptop(currentWallpaper);
                    // 更新预览图位置
                    previewImage.style.objectPosition = `center -${yOffset}px`;
                }
            });
            
            function updateOffsetDisplay() {
                offsetValue.textContent = `偏移: ${yOffset}px`;
            }

            // 绘制微信头像
            function drawAvatar(ctx, img, isRound = true) {
                // 清除画布
                ctx.clearRect(0, 0, avatarSize.width, avatarSize.height);
                
                if (isRound) {
                    // 创建圆形裁剪区域
                    ctx.beginPath();
                    ctx.arc(avatarSize.radius, avatarSize.radius, avatarSize.radius, 0, Math.PI * 2);
                    ctx.clip();
                } else {
                    // 创建圆角矩形裁剪区域
                    ctx.beginPath();
                    roundRect(ctx, 0, 0, avatarSize.width, avatarSize.height, avatarSize.roundRadius);
                    ctx.clip();
                }
                
                // 计算图片缩放和位置
                const scale = Math.max(
                    avatarSize.width / img.width,
                    avatarSize.height / img.height
                );
                
                const x = (avatarSize.width - img.width * scale) / 2;
                const y = (avatarSize.height - img.height * scale) / 2;
                
                ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
            }
            
            // 绘制朋友圈封面
            function drawCover(ctx, img) {
                // 清除画布
                ctx.clearRect(0, 0, coverSize.width, coverSize.height);
                
                // 计算图片缩放和位置
                const scale = Math.max(
                    coverSize.width / img.width,
                    coverSize.height / img.height
                );
                
                const x = (coverSize.width - img.width * scale) / 2;
                const y = (coverSize.height - img.height * scale) / 2;
                
                ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
            }
            
            // 下载微信头像
            function downloadAvatar() {
                if (!currentWallpaper || !currentWallpaper.complete || currentWallpaper.naturalWidth === 0) {
                    alert('壁纸未加载完成，无法下载！');
                    return;
                }
                const originalText = downloadAvatarButton.innerHTML;
                downloadAvatarButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> 下载中...';
                downloadAvatarButton.disabled = true;
                try {
                    // 下载圆形头像
                    const roundCanvas = document.createElement('canvas');
                    roundCanvas.width = avatarSize.width;
                    roundCanvas.height = avatarSize.height;
                    const roundCtx = roundCanvas.getContext('2d');
                    drawAvatar(roundCtx, currentWallpaper, true);
                    exportCanvasAsImage(roundCanvas, '圆形头像.png');
                    // 下载圆角方形头像
                    const squareCanvas = document.createElement('canvas');
                    squareCanvas.width = avatarSize.width;
                    squareCanvas.height = avatarSize.height;
                    const squareCtx = squareCanvas.getContext('2d');
                    drawAvatar(squareCtx, currentWallpaper, false);
                    exportCanvasAsImage(squareCanvas, '方形头像.png');
                    downloadAvatarButton.innerHTML = '<i class="fa-solid fa-check mr-2"></i> 下载成功';
                    downloadAvatarButton.classList.remove('bg-green-500');
                    downloadAvatarButton.classList.add('bg-green-600');
                    setTimeout(() => {
                        downloadAvatarButton.innerHTML = originalText;
                        downloadAvatarButton.classList.remove('bg-green-600');
                        downloadAvatarButton.classList.add('bg-green-500');
                        downloadAvatarButton.disabled = false;
                    }, 2000);
                } catch (error) {
                    console.error('下载失败:', error);
                    downloadAvatarButton.innerHTML = '<i class="fa-solid fa-times mr-2"></i> 下载失败';
                    downloadAvatarButton.classList.remove('bg-green-500');
                    downloadAvatarButton.classList.add('bg-red-500');
                    setTimeout(() => {
                        downloadAvatarButton.innerHTML = originalText;
                        downloadAvatarButton.classList.remove('bg-red-500');
                        downloadAvatarButton.classList.add('bg-green-500');
                        downloadAvatarButton.disabled = false;
                    }, 2000);
                }
            }
            
            // 下载朋友圈封面
            function downloadCover() {
                if (!currentWallpaper || !currentWallpaper.complete || currentWallpaper.naturalWidth === 0) {
                    alert('壁纸未加载完成，无法下载！');
                    return;
                }
                const originalText = downloadCoverButton.innerHTML;
                downloadCoverButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> 下载中...';
                downloadCoverButton.disabled = true;
                try {
                    // 只下载朋友圈完整预览
                    drawMomentFullPreview(currentWallpaper, currentWallpaper);
                    exportCanvasAsImage(momentFullCanvas, '朋友圈预览.png');
                    downloadCoverButton.innerHTML = '<i class="fa-solid fa-check mr-2"></i> 下载成功';
                    downloadCoverButton.classList.remove('bg-blue-500');
                    downloadCoverButton.classList.add('bg-blue-600');
                    setTimeout(() => {
                        downloadCoverButton.innerHTML = originalText;
                        downloadCoverButton.classList.remove('bg-blue-600');
                        downloadCoverButton.classList.add('bg-blue-500');
                        downloadCoverButton.disabled = false;
                    }, 2000);
                } catch (error) {
                    console.error('下载失败:', error);
                    downloadCoverButton.innerHTML = '<i class="fa-solid fa-times mr-2"></i> 下载失败';
                    downloadCoverButton.classList.remove('bg-blue-500');
                    downloadCoverButton.classList.add('bg-red-500');
                    setTimeout(() => {
                        downloadCoverButton.innerHTML = originalText;
                        downloadCoverButton.classList.remove('bg-red-500');
                        downloadCoverButton.classList.add('bg-blue-500');
                        downloadCoverButton.disabled = false;
                    }, 2000);
                }
            }
            
            // 组合下载
            function downloadBoth() {
                if (!currentWallpaper || !currentWallpaper.complete || currentWallpaper.naturalWidth === 0) {
                    alert('壁纸未加载完成，无法下载！');
                    return;
                }
                const originalText = downloadBothButton.innerHTML;
                downloadBothButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> 下载中...';
                downloadBothButton.disabled = true;
                try {
                    // 下载圆形头像
                    const avatarRoundCanvas = document.createElement('canvas');
                    avatarRoundCanvas.width = avatarSize.width;
                    avatarRoundCanvas.height = avatarSize.height;
                    const avatarRoundCtx = avatarRoundCanvas.getContext('2d');
                    drawAvatar(avatarRoundCtx, currentWallpaper, true);
                    exportCanvasAsImage(avatarRoundCanvas, '圆形头像.png');
                    // 下载圆角方形头像
                    const avatarSquareCanvas = document.createElement('canvas');
                    avatarSquareCanvas.width = avatarSize.width;
                    avatarSquareCanvas.height = avatarSize.height;
                    const avatarSquareCtx = avatarSquareCanvas.getContext('2d');
                    drawAvatar(avatarSquareCtx, currentWallpaper, false);
                    exportCanvasAsImage(avatarSquareCanvas, '方形头像.png');
                    // 下载朋友圈完整预览
                    drawMomentFullPreview(currentWallpaper, currentWallpaper);
                    exportCanvasAsImage(momentFullCanvas, '朋友圈预览.png');
                    downloadBothButton.innerHTML = '<i class="fa-solid fa-check mr-2"></i> 下载成功';
                    downloadBothButton.classList.remove('bg-purple-500');
                    downloadBothButton.classList.add('bg-purple-600');
                    setTimeout(() => {
                        downloadBothButton.innerHTML = originalText;
                        downloadBothButton.classList.remove('bg-purple-600');
                        downloadBothButton.classList.add('bg-purple-500');
                        downloadBothButton.disabled = false;
                    }, 2000);
                } catch (error) {
                    console.error('下载失败:', error);
                    downloadBothButton.innerHTML = '<i class="fa-solid fa-times mr-2"></i> 下载失败';
                    downloadBothButton.classList.remove('bg-purple-500');
                    downloadBothButton.classList.add('bg-red-500');
                    setTimeout(() => {
                        downloadBothButton.innerHTML = originalText;
                        downloadBothButton.classList.remove('bg-red-500');
                        downloadBothButton.classList.add('bg-purple-500');
                        downloadBothButton.disabled = false;
                    }, 2000);
                }
            }

            // 绘制朋友圈封面预览
            function drawMomentPreview(wallpaper, avatarImg) {
                // 先裁切圆角矩形
                momentCtx.clearRect(0, 0, momentWidth, momentHeight);
                momentCtx.save();
                momentCtx.beginPath();
                roundRect(momentCtx, 0, 0, momentWidth, momentHeight, 20);
                momentCtx.clip();
                // 绘制壁纸，直接填满canvas
                if (wallpaper) {
                    const imageRatio = wallpaper.width / wallpaper.height;
                    const screenRatio = momentWidth / momentHeight;
                    let drawWidth, drawHeight, drawX, drawY;
                    if (imageRatio > screenRatio) {
                        drawHeight = momentHeight;
                        drawWidth = drawHeight * imageRatio;
                        drawX = -(drawWidth - momentWidth) / 2;
                        drawY = 0;
                    } else {
                        drawWidth = momentWidth;
                        drawHeight = drawWidth / imageRatio;
                        drawX = 0;
                        drawY = -(drawHeight - momentHeight) / 2;
                    }
                    momentCtx.drawImage(wallpaper, drawX, drawY, drawWidth, drawHeight);
                } else {
                    momentCtx.fillStyle = '#EEE';
                    momentCtx.fillRect(0, 0, momentWidth, momentHeight);
                }
                // 底部白色栏
                momentCtx.fillStyle = '#fff';
                momentCtx.fillRect(0, momentHeight - momentBarHeight, momentWidth, momentBarHeight);
                // 底部白色栏左侧说明文字
                momentCtx.save();
                momentCtx.font = 'bold 16px Inter, sans-serif';
                momentCtx.fillStyle = 'rgba(120,120,120,0.85)';
                momentCtx.textAlign = 'left';
                momentCtx.textBaseline = 'middle';
                momentCtx.shadowColor = 'rgba(255,255,255,0.7)';
                momentCtx.shadowBlur = 4;
                momentCtx.fillText('朋友圈封面预览+头像', 24, momentHeight - momentBarHeight/2);
                momentCtx.restore();
                // 右下角头像框
                const avatarX = momentWidth - momentAvatarSize - momentAvatarMargin;
                const avatarY = momentHeight - momentBarHeight/2 - momentAvatarSize/2;
                momentCtx.save();
                momentCtx.beginPath();
                roundRect(momentCtx, avatarX, avatarY, momentAvatarSize, momentAvatarSize, momentAvatarRadius);
                momentCtx.clip();
                if (avatarImg && avatarImg.complete) {
                    const scale = Math.max(momentAvatarSize / avatarImg.width, momentAvatarSize / avatarImg.height);
                    const ax = avatarX + (momentAvatarSize - avatarImg.width * scale) / 2;
                    const ay = avatarY + (momentAvatarSize - avatarImg.height * scale) / 2;
                    momentCtx.drawImage(avatarImg, ax, ay, avatarImg.width * scale, avatarImg.height * scale);
                } else {
                    momentCtx.fillStyle = '#CCC';
                    momentCtx.fillRect(avatarX, avatarY, momentAvatarSize, momentAvatarSize);
                }
                momentCtx.restore();
                // 昵称
                momentCtx.font = 'bold 36px Inter, sans-serif';
                momentCtx.fillStyle = '#222';
                momentCtx.textAlign = 'right';
                momentCtx.textBaseline = 'middle';
                momentCtx.fillText(momentName, avatarX - 20, momentHeight - momentBarHeight/2);
                // 相机icon（右上角）
                momentCtx.save();
                // 只绘制透明PNG，不绘制背景
                if (cameraIconImg.complete && cameraIconImg.naturalWidth > 0) {
                    momentCtx.drawImage(cameraIconImg, momentWidth - 40 - 16, 40 - 16, 32, 32);
                }
                momentCtx.restore();
                // 最后画一圈圆角边框
                momentCtx.save();
                momentCtx.beginPath();
                roundRect(momentCtx, 0.5, 0.5, momentWidth-1, momentHeight-1, 20);
                momentCtx.strokeStyle = '#e5e7eb';
                momentCtx.lineWidth = 4;
                momentCtx.stroke();
                momentCtx.restore();
            }

            // 新增朋友圈完整预览截图
            const momentFullCanvas = document.createElement('canvas');
            momentFullCanvas.width = momentWidth;
            momentFullCanvas.height = momentHeight;
            const momentFullCtx = momentFullCanvas.getContext('2d');
            // 绘制完整朋友圈预览截图
            function drawMomentFullPreview(wallpaper, avatarImg) {
                momentFullCtx.clearRect(0, 0, momentWidth, momentHeight);
                momentFullCtx.save();
                momentFullCtx.beginPath();
                roundRect(momentFullCtx, 0, 0, momentWidth, momentHeight, 20);
                momentFullCtx.clip();
                // 绘制壁纸，直接填满canvas
                if (wallpaper) {
                    const imageRatio = wallpaper.width / wallpaper.height;
                    const screenRatio = momentWidth / momentHeight;
                    let drawWidth, drawHeight, drawX, drawY;
                    if (imageRatio > screenRatio) {
                        drawHeight = momentHeight;
                        drawWidth = drawHeight * imageRatio;
                        drawX = -(drawWidth - momentWidth) / 2;
                        drawY = 0;
                    } else {
                        drawWidth = momentWidth;
                        drawHeight = drawWidth / imageRatio;
                        drawX = 0;
                        drawY = -(drawHeight - momentHeight) / 2;
                    }
                    momentFullCtx.drawImage(wallpaper, drawX, drawY, drawWidth, drawHeight);
                } else {
                    momentFullCtx.fillStyle = '#EEE';
                    momentFullCtx.fillRect(0, 0, momentWidth, momentHeight);
                }
                // 底部白色栏
                momentFullCtx.fillStyle = '#fff';
                momentFullCtx.fillRect(0, momentHeight - momentBarHeight, momentWidth, momentBarHeight);
                // 底部白色栏左侧说明文字
                momentFullCtx.save();
                momentFullCtx.font = 'bold 16px Inter, sans-serif';
                momentFullCtx.fillStyle = 'rgba(120,120,120,0.85)';
                momentFullCtx.textAlign = 'left';
                momentFullCtx.textBaseline = 'middle';
                momentFullCtx.shadowColor = 'rgba(255,255,255,0.7)';
                momentFullCtx.shadowBlur = 4;
                momentFullCtx.fillText('朋友圈封面预览+头像', 24, momentHeight - momentBarHeight/2);
                momentFullCtx.restore();
                // 右下角头像框
                const avatarX = momentWidth - momentAvatarSize - momentAvatarMargin;
                const avatarY = momentHeight - momentBarHeight/2 - momentAvatarSize/2;
                momentFullCtx.save();
                momentFullCtx.beginPath();
                roundRect(momentFullCtx, avatarX, avatarY, momentAvatarSize, momentAvatarSize, momentAvatarRadius);
                momentFullCtx.clip();
                if (avatarImg && avatarImg.complete) {
                    const scale = Math.max(momentAvatarSize / avatarImg.width, momentAvatarSize / avatarImg.height);
                    const ax = avatarX + (momentAvatarSize - avatarImg.width * scale) / 2;
                    const ay = avatarY + (momentAvatarSize - avatarImg.height * scale) / 2;
                    momentFullCtx.drawImage(avatarImg, ax, ay, avatarImg.width * scale, avatarImg.height * scale);
                } else {
                    momentFullCtx.fillStyle = '#CCC';
                    momentFullCtx.fillRect(avatarX, avatarY, momentAvatarSize, momentAvatarSize);
                }
                momentFullCtx.restore();
                // 昵称
                momentFullCtx.font = 'bold 36px Inter, sans-serif';
                momentFullCtx.fillStyle = '#222';
                momentFullCtx.textAlign = 'right';
                momentFullCtx.textBaseline = 'middle';
                momentFullCtx.fillText(momentName, avatarX - 20, momentHeight - momentBarHeight/2);
                // 相机icon
                momentFullCtx.save();
                // 只绘制透明PNG，不绘制背景
                if (cameraIconImg.complete && cameraIconImg.naturalWidth > 0) {
                    momentFullCtx.drawImage(cameraIconImg, momentWidth - 40 - 16, 40 - 16, 32, 32);
                }
                momentFullCtx.restore();
                // 边框
                momentFullCtx.save();
                momentFullCtx.beginPath();
                roundRect(momentFullCtx, 0.5, 0.5, momentWidth-1, momentHeight-1, 20);
                momentFullCtx.strokeStyle = '#e5e7eb';
                momentFullCtx.lineWidth = 4;
                momentFullCtx.stroke();
                momentFullCtx.restore();
            }
        });
    </script>
</body>
</html>
    